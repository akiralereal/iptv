<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV é¢‘é“ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            color: #666;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab:hover {
            color: #1890ff;
            background: #f5f5f5;
        }

        .tab.active {
            color: #1890ff;
            border-bottom-color: #1890ff;
            font-weight: 600;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #1890ff;
            color: white;
        }

        .btn-primary:hover {
            background: #40a9ff;
        }

        .btn-success {
            background: #52c41a;
            color: white;
        }

        .btn-success:hover {
            background: #73d13d;
        }

        .btn-danger {
            background: #ff4d4f;
            color: white;
        }

        .main-content {
            margin-top: 0;
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 8px;
        }

        .search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .channels-container {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
            height: calc(100vh - 250px);
        }

        .category-sidebar {
            border-right: 2px solid #f0f0f0;
            padding-right: 15px;
            overflow-y: auto;
            height: 100%;
        }

        .category-nav-item {
            padding: 10px 15px;
            margin-bottom: 5px;
            background: #fafafa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: #333;
            border-left: 3px solid transparent;
        }

        .category-nav-item:hover {
            background: #e6f7ff;
            border-left-color: #40a9ff;
        }

        .category-nav-item.active {
            background: #e6f7ff;
            border-left-color: #1890ff;
            color: #1890ff;
            font-weight: 600;
        }

        .category-nav-item .count {
            float: right;
            color: #999;
            font-size: 12px;
        }

        .channels-content {
            overflow-y: auto;
            height: 100%;
        }

        .channel-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .channel-item {
            padding: 12px;
            background: #fafafa;
            border-radius: 4px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            font-size: 14px;
            border: 1px solid transparent;
        }

        .channel-item:hover {
            background: #e6f7ff;
            border-color: #1890ff;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.2);
        }

        .custom-groups {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .group {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-bottom: 15px;
            padding: 15px;
            background: #fafafa;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .group-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .group-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .group-channels {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .channel-tag {
            padding: 6px 12px;
            background: white;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .channel-tag .remove {
            color: #ff4d4f;
            cursor: pointer;
            font-weight: bold;
        }

        .channel-tag .remove:hover {
            color: #ff7875;
        }

        .empty-group {
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 400px;
        }

        .modal-content h3 {
            margin-bottom: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            min-width: 300px;
            max-width: 500px;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .status.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .status.success {
            background: #f6ffed;
            border: 1px solid #52c41a;
            color: #52c41a;
        }

        .status.error {
            background: #fff2f0;
            border: 1px solid #ff4d4f;
            color: #ff4d4f;
        }

        .external-panel {
            margin-top: 20px;
        }

        .external-usage {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 12px;
            font-size: 13px;
            line-height: 1.8;
        }

        .external-usage h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #1890ff;
        }

        .external-usage ol {
            margin: 0;
            padding-left: 20px;
            color: #595959;
        }

        .external-usage li {
            margin-bottom: 4px;
        }

        .external-toggles {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .external-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .external-container {
            display: grid;
            grid-template-columns: 250px 1fr 280px;
            gap: 20px;
            height: calc(100vh - 250px);
        }

        .external-sidebar {
            border-right: 2px solid #f0f0f0;
            padding-right: 15px;
            overflow-y: auto;
            height: 100%;
        }

        .external-nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            background: #fafafa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            position: relative;
        }

        .external-nav-item:hover {
            background: #e6f7ff;
            border-left-color: #40a9ff;
        }

        .external-nav-item.active {
            background: #e6f7ff;
            border-left-color: #1890ff;
            font-weight: 600;
        }

        .external-nav-title {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .external-nav-item.active .external-nav-title {
            color: #1890ff;
        }

        .external-nav-meta {
            font-size: 11px;
            color: #999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .external-detail {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .external-usage-side {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 13px;
            line-height: 1.8;
            overflow-y: auto;
            height: 100%;
        }

        .external-usage-side h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #1890ff;
        }

        .external-usage-side ol {
            margin: 0;
            padding-left: 20px;
            color: #595959;
        }

        .external-usage-side li {
            margin-bottom: 8px;
        }

        .external-detail-header {
            padding: 16px 20px;
            background: #fafafa;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .external-detail-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .external-detail-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .external-detail-footer {
            padding: 16px 20px;
            background: #fafafa;
            border-top: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .external-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            font-size: 14px;
            text-align: center;
        }

        .external-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 16px;
            max-height: calc(100vh - 380px);
            overflow-y: auto;
            padding: 4px;
        }

        .external-item {
            border: 1px solid #d9d9d9;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        .external-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .external-item-header {
            padding: 12px 16px;
            background: #f5f5f5;
            border-bottom: 1px solid #e8e8e8;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .external-item-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .external-item-status {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-badge.enabled {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .status-badge.disabled {
            background: #f5f5f5;
            color: #999;
            border: 1px solid #d9d9d9;
        }

        .external-item-body {
            padding: 16px;
            flex: 1;
        }

        .external-field {
            margin-bottom: 12px;
        }

        .external-field:last-child {
            margin-bottom: 0;
        }

        .external-field label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .external-field input[type="text"],
        .external-field input[type="number"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.3s;
        }

        .external-field input:focus {
            border-color: #1890ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }

        .external-field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-hint {
            margin-top: 4px;
            font-size: 11px;
            color: #999;
            line-height: 1.4;
        }

        .external-item-footer {
            padding: 12px 16px;
            background: #fafafa;
            border-top: 1px solid #e8e8e8;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .external-switches {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .external-switches label {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        .external-switches input[type="checkbox"] {
            margin-right: 4px;
        }

        .external-actions {
            display: flex;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                white-space: nowrap;
                flex-shrink: 0;
            }

            .external-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .external-sidebar {
                border-right: none;
                border-bottom: 2px solid #f0f0f0;
                padding-right: 0;
                padding-bottom: 10px;
                margin-bottom: 15px;
                max-height: 150px;
                height: auto;
            }

            .external-usage-side {
                display: none;
            }

            .external-detail {
                height: auto;
                min-height: 400px;
            }

            .external-field-row {
                grid-template-columns: 1fr;
            }

            .channels-container {
                grid-template-columns: 1fr;
            }

            .category-sidebar {
                border-right: none;
                border-bottom: 2px solid #f0f0f0;
                padding-right: 0;
                padding-bottom: 10px;
                margin-bottom: 15px;
                max-height: 150px;
            }
        }

        .system-config-item {
            margin-bottom: 15px;
        }

        .system-config-item label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }

        .system-config-item input[type="text"],
        .system-config-item input[type="number"],
        .system-config-item select {
            width: 100%;
            padding: 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
        }

        .system-config-item input[type="checkbox"] {
            margin-right: 6px;
        }

        .system-config-hint {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .system-config-warning {
            background: #fff7e6;
            border: 1px solid #ffd666;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 15px;
            color: #ad6800;
            font-size: 13px;
        }

        .system-config-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-warning {
            background: #faad14;
            color: white;
        }

        .btn-warning:hover {
            background: #ffc53d;
        }
    </style>
</head>
<body>
    <!-- Toast é€šçŸ¥ -->
    <div class="status" id="status"></div>
    
    <div class="container">
        <div class="header">
            <div class="tabs">
                <button class="tab active" onclick="switchTab(0)">ğŸ“‹ æ‰€æœ‰é¢‘é“</button>
                <button class="tab" onclick="switchTab(1)">ğŸŒ æºç®¡ç†</button>
                <button class="tab" onclick="switchTab(2)">âš™ï¸ ç³»ç»Ÿé…ç½®</button>
            </div>
        </div>

        <div class="main-content">
            <div class="panel active">
                <input type="text" class="search-box" id="searchBox" placeholder="æœç´¢é¢‘é“..." onkeyup="filterChannels()">
                <div class="channels-container">
                    <div class="category-sidebar" id="categorySidebar"></div>
                    <div class="channels-content">
                        <div class="channel-list" id="channelList"></div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="external-toggles">
                    <label>
                        <input type="checkbox" id="externalEnabled" onchange="toggleExternalEnabled()">
                        å¯ç”¨è‡ªå®šä¹‰æº
                    </label>
                    <label>
                        <input type="checkbox" id="externalIncludeInPlaylists" onchange="toggleExternalIncludeInPlaylists()">
                        å†™å…¥ m3u/txt
                    </label>
                    <label>
                        <input type="checkbox" id="miguUpdateOnStartup" onchange="toggleMiguUpdateOnStartup()">
                        å’ªå’•æºé‡å¯æ—¶æ›´æ–°
                    </label>
                </div>
                <div class="external-buttons">
                    <button class="btn btn-primary" onclick="addExternalSource()">â¥ æ·»åŠ æº</button>
                    <button class="btn btn-success" onclick="saveExternalSources()">ğŸ’¾ ä¿å­˜</button>
                </div>
                <div class="external-container">
                    <div class="external-sidebar" id="externalSidebar"></div>
                    <div class="external-detail" id="externalDetail">
                        <div class="external-empty">è¯·åœ¨å·¦ä¾§é€‰æ‹©æˆ–æ·»åŠ æº</div>
                    </div>
                    <div class="external-usage-side">
                        <h4>ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
                        <ol>
                            <li>ç‚¹å‡»å·¦ä¾§åˆ—è¡¨é€‰æ‹©è¦ç¼–è¾‘çš„å¤–éƒ¨æº</li>
                            <li>å¡«å†™<strong>ç½‘é¡µåœ°å€</strong>åç‚¹å‡»<strong>"æŠ“å–"</strong>ï¼Œm3u8 é“¾æ¥ä¼šè‡ªåŠ¨å¡«å……</li>
                            <li>ä¹Ÿå¯ç›´æ¥å¡«å†™ <strong>m3u8 é“¾æ¥</strong>ï¼Œç•™ç©ºç½‘é¡µåœ°å€</li>
                            <li>ä¿®æ”¹åç‚¹å‡» <strong>"ğŸ’¾ ä¿å­˜"</strong> ä¿å­˜é…ç½®</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="system-config-warning">
                    âš ï¸ ä¿®æ”¹ç³»ç»Ÿé…ç½®åéœ€è¦<strong>é‡å¯æœåŠ¡</strong>æ‰èƒ½ç”Ÿæ•ˆ
                </div>
                <div class="system-config-item">
                    <label>å’ªå’•ç”¨æˆ·ID</label>
                    <input type="text" id="sysUserId" placeholder="ç•™ç©ºä¸ºæ¸¸å®¢æ¨¡å¼">
                    <div class="system-config-hint">VIPç”¨æˆ·å¡«å†™ï¼Œæ¸¸å®¢æ¨¡å¼å¯ç•™ç©º</div>
                </div>
                <div class="system-config-item">
                    <label>å’ªå’•Token</label>
                    <input type="text" id="sysToken" placeholder="ç•™ç©ºä¸ºæ¸¸å®¢æ¨¡å¼">
                    <div class="system-config-hint">VIPç”¨æˆ·å¡«å†™ï¼Œæ¸¸å®¢æ¨¡å¼å¯ç•™ç©º</div>
                </div>
                <div class="system-config-item">
                    <label>ç”»è´¨</label>
                    <select id="sysRateType">
                        <option value="2">æ ‡æ¸…</option>
                        <option value="3">é«˜æ¸…ï¼ˆéœ€VIPï¼‰</option>
                        <option value="4">è“å…‰ï¼ˆéœ€VIPï¼‰</option>
                        <option value="7">åŸç”»ï¼ˆéœ€VIPï¼‰</option>
                        <option value="9">4Kï¼ˆéœ€VIPï¼‰</option>
                    </select>
                    <div class="system-config-hint">æ— VIPæ—¶è‡ªåŠ¨é™çº§ä¸º720p</div>
                </div>
                <div class="system-config-item">
                    <label>æœåŠ¡ç«¯å£</label>
                    <input type="number" id="sysPort" placeholder="1905">
                </div>
                <div class="system-config-item">
                    <label>å…¬ç½‘åœ°å€</label>
                    <input type="text" id="sysHost" placeholder="http://ip:port">
                    <div class="system-config-hint">é€‰å¡«ï¼Œç”¨äºç”Ÿæˆæ’­æ”¾åˆ—è¡¨é“¾æ¥</div>
                </div>
                <div class="system-config-item">
                    <label>è®¿é—®å¯†ç </label>
                    <input type="text" id="sysPass" placeholder="ç•™ç©ºè¡¨ç¤ºæ— å¯†ç ">
                    <div class="system-config-hint">è®¾ç½®åè®¿é—®æ ¼å¼ï¼šhttp://ip:port/å¯†ç /...</div>
                </div>
                <div class="system-config-item">
                    <label>èŠ‚ç›®å•æ›´æ–°é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
                    <input type="number" id="sysProgramInterval" placeholder="6">
                </div>
                <div class="system-config-item">
                    <label>
                        <input type="checkbox" id="sysEnableHDR">
                        å¯ç”¨ HDR
                    </label>
                </div>
                <div class="system-config-item">
                    <label>
                        <input type="checkbox" id="sysEnableH265">
                        å¯ç”¨ H.265ï¼ˆå¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼‰
                    </label>
                </div>
                <div class="system-config-actions">
                    <button class="btn btn-success" onclick="saveSystemConfig()">ğŸ’¾ ä¿å­˜ç³»ç»Ÿé…ç½®</button>
                    <button class="btn btn-warning" onclick="restartService()">ğŸ”„ é‡å¯æœåŠ¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allChannels = [];
        let externalConfig = {
            enabled: false,
            includeInPlaylists: true,
            sources: []
        };
        let systemConfig = {};
        let updatingSourceIndex = null; // è®°å½•æ­£åœ¨æ›´æ–°çš„æºç´¢å¼•

        // Tab åˆ‡æ¢åŠŸèƒ½
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const panels = document.querySelectorAll('.panel');
            
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            panels.forEach((panel, i) => {
                if (i === index) {
                    panel.classList.add('active');
                } else {
                    panel.classList.remove('active');
                }
            });
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                console.log('å¼€å§‹åŠ è½½æ•°æ®...');
                
                // åŠ è½½æ‰€æœ‰é¢‘é“
                console.log('è¯·æ±‚é¢‘é“åˆ—è¡¨...');
                const channelsRes = await fetch('/api/channels');
                if (!channelsRes.ok) {
                    throw new Error(`é¢‘é“APIè¯·æ±‚å¤±è´¥: ${channelsRes.status}`);
                }
                allChannels = await channelsRes.json();
                console.log('é¢‘é“æ•°æ®åŠ è½½æˆåŠŸ:', allChannels.length, 'ä¸ªåˆ†ç±»');
                
                // åŠ è½½å¤–éƒ¨æºé…ç½®
                console.log('è¯·æ±‚å¤–éƒ¨æºé…ç½®...');
                const externalRes = await fetch('/api/external-sources');
                if (!externalRes.ok) {
                    throw new Error(`å¤–éƒ¨æºAPIè¯·æ±‚å¤±è´¥: ${externalRes.status}`);
                }
                const externalPayload = await externalRes.json();
                externalConfig = normalizeExternalConfig(externalPayload);
                console.log('å¤–éƒ¨æºé…ç½®åŠ è½½æˆåŠŸ:', externalConfig.sources?.length || 0, 'ä¸ªæº');
                
                // åŠ è½½ç³»ç»Ÿé…ç½®
                console.log('è¯·æ±‚ç³»ç»Ÿé…ç½®...');
                const systemRes = await fetch('/api/system-config');
                if (!systemRes.ok) {
                    throw new Error(`ç³»ç»Ÿé…ç½®APIè¯·æ±‚å¤±è´¥: ${systemRes.status}`);
                }
                systemConfig = await systemRes.json();
                console.log('ç³»ç»Ÿé…ç½®åŠ è½½æˆåŠŸ');
                
                // æ¸²æŸ“æ‰€æœ‰å†…å®¹
                console.log('å¼€å§‹æ¸²æŸ“é¡µé¢...');
                renderChannels();
                renderExternalSources();
                renderSystemConfig();
                console.log('é¡µé¢æ¸²æŸ“å®Œæˆ');
                
                showStatus('æ•°æ®åŠ è½½æˆåŠŸ', 'success');
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showStatus('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
                // å³ä½¿å¤±è´¥ä¹Ÿå°è¯•æ¸²æŸ“ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                renderChannels();
                renderGroups();
                renderExternalSources();
            }
        }

        let currentCategory = 'all'; // å½“å‰é€‰ä¸­çš„åˆ†ç±»
        let selectedExternalIndex = null; // å½“å‰é€‰ä¸­çš„å¤–éƒ¨æºç´¢å¼•

        // æ¸²æŸ“é¢‘é“åˆ—è¡¨
        function renderChannels() {
            const channelContainer = document.getElementById('channelList');
            const categoryContainer = document.getElementById('categorySidebar');
            
            if (!allChannels || allChannels.length === 0) {
                channelContainer.innerHTML = '<div class="empty-group" style="grid-column: 1/-1;">æš‚æ— é¢‘é“æ•°æ®<br><br>å¯èƒ½åŸå› ï¼š<br>1. æœåŠ¡åˆšå¯åŠ¨ï¼Œæ•°æ®æ­£åœ¨åŠ è½½ä¸­...<br>2. æœªé…ç½®å’ªå’•è´¦å·ï¼ˆè¯·åœ¨"ç³»ç»Ÿé…ç½®"ä¸­å¡«å†™ï¼‰<br>3. ç½‘ç»œè¿æ¥é—®é¢˜</div>';
                console.log('é¢‘é“æ•°æ®ä¸ºç©º:', allChannels);
                return;
            }
            
            console.log(`æ­£åœ¨æ¸²æŸ“ ${allChannels.length} ä¸ªé¢‘é“åˆ†ç±»`);
            
            // æ¸²æŸ“å·¦ä¾§åˆ†ç±»å¯¼èˆª
            categoryContainer.innerHTML = '';
            
            // æ·»åŠ "å…¨éƒ¨"é€‰é¡¹
            const totalCount = allChannels.reduce((sum, cat) => sum + (cat.dataList ? cat.dataList.length : 0), 0);
            const allItem = document.createElement('div');
            allItem.className = 'category-nav-item' + (currentCategory === 'all' ? ' active' : '');
            allItem.innerHTML = `å…¨éƒ¨<span class="count">${totalCount}</span>`;
            allItem.onclick = () => selectCategory('all');
            categoryContainer.appendChild(allItem);
            
            // æ·»åŠ å„ä¸ªåˆ†ç±»
            allChannels.forEach((category, index) => {
                if (!category.dataList || category.dataList.length === 0) return;
                
                const navItem = document.createElement('div');
                navItem.className = 'category-nav-item' + (currentCategory === index ? ' active' : '');
                navItem.innerHTML = `${category.name}<span class="count">${category.dataList.length}</span>`;
                navItem.onclick = () => selectCategory(index);
                categoryContainer.appendChild(navItem);
            });
            
            // æ¸²æŸ“å³ä¾§é¢‘é“åˆ—è¡¨
            renderChannelList();
        }

        function selectCategory(categoryIndex) {
            currentCategory = categoryIndex;
            
            // æ›´æ–°åˆ†ç±»é«˜äº®
            document.querySelectorAll('.category-nav-item').forEach((item, index) => {
                if (categoryIndex === 'all' && index === 0) {
                    item.classList.add('active');
                } else if (categoryIndex === index - 1) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // æ¸²æŸ“é¢‘é“åˆ—è¡¨
            renderChannelList();
        }

        function renderChannelList() {
            const container = document.getElementById('channelList');
            container.innerHTML = '';
            
            if (currentCategory === 'all') {
                // æ˜¾ç¤ºæ‰€æœ‰é¢‘é“
                allChannels.forEach(category => {
                    if (!category.dataList || category.dataList.length === 0) return;
                    
                    category.dataList.forEach(channel => {
                        const channelDiv = document.createElement('div');
                        channelDiv.className = 'channel-item';
                        channelDiv.innerHTML = channel.name;
                        channelDiv.dataset.categoryName = category.name;
                        channelDiv.dataset.channelName = channel.name;
                        container.appendChild(channelDiv);
                    });
                });
            } else {
                // æ˜¾ç¤ºç‰¹å®šåˆ†ç±»çš„é¢‘é“
                const category = allChannels[currentCategory];
                if (category && category.dataList) {
                    category.dataList.forEach(channel => {
                        const channelDiv = document.createElement('div');
                        channelDiv.className = 'channel-item';
                        channelDiv.innerHTML = channel.name;
                        channelDiv.dataset.categoryName = category.name;
                        channelDiv.dataset.channelName = channel.name;
                        container.appendChild(channelDiv);
                    });
                }
            }
        }

        // æœç´¢é¢‘é“
        function filterChannels() {
            const keyword = document.getElementById('searchBox').value.toLowerCase();
            const items = document.querySelectorAll('.channel-item');
            
            if (!keyword) {
                // æ²¡æœ‰æœç´¢å…³é”®è¯ï¼Œæ˜¾ç¤ºå½“å‰åˆ†ç±»çš„æ‰€æœ‰é¢‘é“
                items.forEach(item => {
                    item.style.display = 'block';
                });
            } else {
                // æœ‰æœç´¢å…³é”®è¯ï¼Œç­›é€‰åŒ¹é…çš„é¢‘é“
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(keyword) ? 'block' : 'none';
                });
            }
        }

        function normalizeExternalConfig(payload) {
            const data = payload && payload.data !== undefined ? payload.data : payload || {};
            if (Array.isArray(data)) {
                return {
                    enabled: true,
                    includeInPlaylists: true,
                    updateOnStartup: true,
                    sources: data
                };
            }
            return {
                enabled: !!data.enabled,
                includeInPlaylists: data.includeInPlaylists !== false,
                updateOnStartup: data.updateOnStartup !== false,
                sources: Array.isArray(data.sources) ? data.sources : []
            };
        }

        function renderExternalSources() {
            const sidebar = document.getElementById('externalSidebar');
            const detail = document.getElementById('externalDetail');

            document.getElementById('externalEnabled').checked = !!externalConfig.enabled;
            document.getElementById('externalIncludeInPlaylists').checked = externalConfig.includeInPlaylists !== false;
            document.getElementById('miguUpdateOnStartup').checked = externalConfig.updateOnStartup !== false;

            // æ¸²æŸ“å·¦ä¾§åˆ—è¡¨
            sidebar.innerHTML = '';
            if (!externalConfig.sources || externalConfig.sources.length === 0) {
                sidebar.innerHTML = '<div class="empty-group">æš‚æ— å¤–éƒ¨æº<br><br>ç‚¹å‡»"æ·»åŠ æº"<br>å¼€å§‹é…ç½®</div>';
                detail.innerHTML = '<div class="external-empty">è¯·åœ¨å·¦ä¾§é€‰æ‹©æˆ–æ·»åŠ æº</div>';
                selectedExternalIndex = null;
                return;
            }

            externalConfig.sources.forEach((source, index) => {
                const navItem = document.createElement('div');
                navItem.className = 'external-nav-item' + (selectedExternalIndex === index ? ' active' : '');
                
                const statusIcon = source.enabled !== false ? 'âœ“' : 'Ã—';
                const statusColor = source.enabled !== false ? '#52c41a' : '#999';
                
                navItem.innerHTML = `
                    <div class="external-nav-title">${source.name || 'æœªå‘½åæº'}</div>
                    <div class="external-nav-meta">
                        <span>${source.group || 'æœªåˆ†ç»„'}</span>
                        <span style="color: ${statusColor};">${statusIcon}</span>
                    </div>
                `;
                navItem.onclick = () => selectExternalSource(index);
                sidebar.appendChild(navItem);
            });

            // æ¸²æŸ“å³ä¾§è¯¦æƒ…
            if (selectedExternalIndex !== null && externalConfig.sources[selectedExternalIndex]) {
                renderExternalDetail(selectedExternalIndex);
            } else if (externalConfig.sources.length > 0) {
                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
                selectExternalSource(0);
            }
        }

        function selectExternalSource(index) {
            selectedExternalIndex = index;
            
            // æ›´æ–°å·¦ä¾§é«˜äº®
            document.querySelectorAll('.external-nav-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // æ¸²æŸ“å³ä¾§è¯¦æƒ…
            renderExternalDetail(index);
        }

        function renderExternalDetail(index) {
            const detail = document.getElementById('externalDetail');
            const source = externalConfig.sources[index];
            
            if (!source) {
                detail.innerHTML = '<div class="external-empty">è¯·åœ¨å·¦ä¾§é€‰æ‹©æˆ–æ·»åŠ æº</div>';
                return;
            }
            
            const isEnabled = source.enabled !== false;
            const statusBadge = isEnabled 
                ? '<span class="status-badge enabled">âœ“ å·²å¯ç”¨</span>' 
                : '<span class="status-badge disabled">Ã— å·²ç¦ç”¨</span>';
            
            detail.innerHTML = `
                <div class="external-detail-header">
                    <div class="external-detail-title">${source.name || 'æœªå‘½åæº'}</div>
                    ${statusBadge}
                </div>
                <div class="external-detail-body">
                    <div class="external-field-row">
                        <div class="external-field">
                            <label>é¢‘é“åç§° *</label>
                            <input type="text" value="${source.name || ''}" oninput="updateExternalField(${index}, 'name', this.value)" placeholder="ä¾‹ï¼šä½“è‚²é¢‘é“">
                        </div>
                        <div class="external-field">
                            <label>æ‰€å±åˆ†ç»„ *</label>
                            <input type="text" value="${source.group || ''}" oninput="updateExternalField(${index}, 'group', this.value)" placeholder="ä¾‹ï¼šä½“è‚²">
                        </div>
                    </div>
                    <div class="external-field">
                        <label>ç½‘é¡µåœ°å€ï¼ˆå¾…æŠ“å–ï¼‰</label>
                        <input type="text" value="${source.webUrl || ''}" oninput="updateExternalField(${index}, 'webUrl', this.value)" placeholder="ç•™ç©ºåˆ™ç›´æ¥ä½¿ç”¨ m3u8 é“¾æ¥">
                        <div class="form-hint">å¡«å†™åç‚¹å‡»"æŠ“å–"æŒ‰é’®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æå– m3u8 é“¾æ¥</div>
                    </div>
                    <div class="external-field">
                        <label>m3u8 ç›´æ’­é“¾æ¥ *</label>
                        <input type="text" value="${source.m3u8Url || ''}" oninput="updateExternalField(${index}, 'm3u8Url', this.value)" placeholder="æŠ“å–åè‡ªåŠ¨å¡«å……ï¼Œä¹Ÿå¯æ‰‹åŠ¨è¾“å…¥">
                        <div class="form-hint">æŠ“å–æˆåŠŸåä¼šè‡ªåŠ¨å¡«å……ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‰‹åŠ¨å¡«å†™</div>
                    </div>
                    <div class="external-field">
                        <label>è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" min="1" value="${source.refreshInterval || 60}" oninput="updateExternalField(${index}, 'refreshInterval', parseInt(this.value) || 60)" placeholder="60">
                        <div class="form-hint">æ¯éš”å¤šå°‘åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–° m3u8 é“¾æ¥ï¼Œé»˜è®¤ 60 åˆ†é’Ÿ</div>
                    </div>
                </div>
                <div class="external-detail-footer">
                    <div class="external-switches">
                        <label>
                            <input type="checkbox" ${source.enabled !== false ? 'checked' : ''} onchange="updateExternalField(${index}, 'enabled', this.checked)">
                            å¯ç”¨æ­¤æº
                        </label>
                        <label>
                            <input type="checkbox" ${source.autoRefresh !== false ? 'checked' : ''} onchange="updateExternalField(${index}, 'autoRefresh', this.checked)">
                            è‡ªåŠ¨åˆ·æ–°
                        </label>
                        <label>
                            <input type="checkbox" ${source.updateOnStartup !== false ? 'checked' : ''} onchange="updateExternalField(${index}, 'updateOnStartup', this.checked)">
                            é‡å¯æ—¶æ›´æ–°
                        </label>
                    </div>
                    <div class="external-actions">
                        <button class="btn btn-small btn-primary" onclick="updateExternalSource(${index})" ${updatingSourceIndex === index ? 'disabled' : ''}>
                            ${updatingSourceIndex === index ? 'ğŸ”„ æŠ“å–ä¸­...' : 'ğŸ” æŠ“å–'}
                        </button>
                        <button class="btn btn-small btn-danger" onclick="removeExternalSource(${index})" ${updatingSourceIndex === index ? 'disabled' : ''}>ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
            `;
        }

        function toggleExternalEnabled() {
            externalConfig.enabled = document.getElementById('externalEnabled').checked;
        }

        function toggleExternalIncludeInPlaylists() {
            externalConfig.includeInPlaylists = document.getElementById('externalIncludeInPlaylists').checked;
        }

        function toggleMiguUpdateOnStartup() {
            externalConfig.updateOnStartup = document.getElementById('miguUpdateOnStartup').checked;
        }

        function addExternalSource() {
            externalConfig.sources.push({
                name: '',
                group: 'å…¶ä»–',
                webUrl: '',
                m3u8Url: '',
                enabled: true,
                autoRefresh: true, // é»˜è®¤å¼€å¯è‡ªåŠ¨åˆ·æ–°
                refreshInterval: 60, // é»˜è®¤60åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
                updateOnStartup: true, // é»˜è®¤é‡å¯æ—¶æ›´æ–°
                extractOptions: {
                    waitTime: 5000,
                    headless: true
                }
            });
            selectedExternalIndex = externalConfig.sources.length - 1;
            renderExternalSources();
        }

        function removeExternalSource(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤–éƒ¨æºå—?')) {
                externalConfig.sources.splice(index, 1);
                if (selectedExternalIndex === index) {
                    selectedExternalIndex = externalConfig.sources.length > 0 ? 0 : null;
                } else if (selectedExternalIndex > index) {
                    selectedExternalIndex--;
                }
                renderExternalSources();
            }
        }

        function updateExternalField(index, field, value) {
            externalConfig.sources[index][field] = value;
            // æ›´æ–°å·¦ä¾§åˆ—è¡¨å’Œå¤´éƒ¨çŠ¶æ€
            if (field === 'name' || field === 'enabled') {
                renderExternalSources();
            }
        }

        async function updateExternalSource(index) {
            if (updatingSourceIndex !== null) {
                showStatus('è¯·ç­‰å¾…å½“å‰æŠ“å–å®Œæˆ', 'error');
                return;
            }
            
            const sourceName = externalConfig.sources[index].name || 'å¤–éƒ¨æº';
            updatingSourceIndex = index;
            renderExternalSources(); // åˆ·æ–°UIæ˜¾ç¤ºloadingçŠ¶æ€
            
            try {
                // å…ˆä¿å­˜é…ç½®ï¼Œç¡®ä¿åç«¯ç´¢å¼•åŒæ­¥
                showStatus(`æ­£åœ¨ä¿å­˜é…ç½®...`, 'info');
                const saveResponse = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'save', sources: externalConfig })
                });
                
                if (!saveResponse.ok) {
                    showStatus('é…ç½®ä¿å­˜å¤±è´¥ï¼Œæ— æ³•æ›´æ–°', 'error');
                    return;
                }
                
                // ä¿å­˜æˆåŠŸåæ‰§è¡Œæ›´æ–°
                showStatus(`æ­£åœ¨æå– ${sourceName} çš„ m3u8 é“¾æ¥...`, 'info');
                
                const response = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'update', index })
                });

                const result = await response.json();
                
                // é‡æ–°åŠ è½½é…ç½®ç¡®ä¿UIåŒæ­¥ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥éƒ½åŠ è½½ï¼‰
                const externalRes = await fetch('/api/external-sources');
                const externalPayload = await externalRes.json();
                externalConfig = normalizeExternalConfig(externalPayload);
                
                // æ ¹æ® result.success åˆ¤æ–­è€Œä¸æ˜¯ response.ok
                if (result.success !== false) {
                    const message = result.warning 
                        ? `${sourceName} æ›´æ–°æˆåŠŸï¼ˆ${result.warning}ï¼‰` 
                        : `${sourceName} æ›´æ–°æˆåŠŸï¼m3u8 é“¾æ¥å·²è‡ªåŠ¨å¡«å……`;
                    showStatus(message, 'success');
                } else {
                    showStatus(`${sourceName} æ›´æ–°å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showStatus(`${sourceName} æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            } finally {
                updatingSourceIndex = null;
                renderExternalSources(); // æ¸…é™¤loadingçŠ¶æ€å¹¶åˆ·æ–°UI
            }
        }

        async function saveExternalSources() {
            try {
                showStatus('æ­£åœ¨ä¿å­˜é…ç½®...', 'info');
                
                const response = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'save', sources: externalConfig })
                });

                const result = await response.json();
                if (response.ok && result.success !== false) {
                    showStatus('å¤–éƒ¨æºé…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    renderExternalSources(); // ä¿å­˜æˆåŠŸååˆ·æ–°UI
                } else {
                    showStatus(result.message || 'å¤–éƒ¨æºé…ç½®ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('å¤–éƒ¨æºé…ç½®ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯ï¼ˆToast é€šçŸ¥ï¼‰
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            
            // è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                status.classList.add('show');
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        // æ¸²æŸ“ç³»ç»Ÿé…ç½®
        function renderSystemConfig() {
            document.getElementById('sysUserId').value = systemConfig.userId || '';
            document.getElementById('sysToken').value = systemConfig.token || '';
            document.getElementById('sysPort').value = systemConfig.port || 1905;
            document.getElementById('sysHost').value = systemConfig.host || '';
            document.getElementById('sysRateType').value = systemConfig.rateType || 3;
            document.getElementById('sysPass').value = systemConfig.pass || '';
            document.getElementById('sysProgramInterval').value = systemConfig.programInfoUpdateInterval || '6';
            document.getElementById('sysEnableHDR').checked = systemConfig.enableHDR !== false;
            document.getElementById('sysEnableH265').checked = systemConfig.enableH265 !== false;
        }

        // ä¿å­˜ç³»ç»Ÿé…ç½®
        async function saveSystemConfig() {
            try {
                const config = {
                    userId: document.getElementById('sysUserId').value,
                    token: document.getElementById('sysToken').value,
                    port: parseInt(document.getElementById('sysPort').value) || 1905,
                    host: document.getElementById('sysHost').value,
                    rateType: parseInt(document.getElementById('sysRateType').value) || 3,
                    pass: document.getElementById('sysPass').value,
                    programInfoUpdateInterval: document.getElementById('sysProgramInterval').value || '6',
                    enableHDR: document.getElementById('sysEnableHDR').checked,
                    enableH265: document.getElementById('sysEnableH265').checked
                };

                const response = await fetch('/api/system-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(result.message, 'success');
                } else {
                    showStatus(result.message || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é‡å¯æœåŠ¡
        async function restartService() {
            if (!confirm('ç¡®å®šè¦é‡å¯æœåŠ¡å—ï¼Ÿ\n\næ³¨æ„ï¼š\n1. é‡å¯æœŸé—´æœåŠ¡å°†æš‚æ—¶ä¸å¯ç”¨ï¼ˆçº¦5-10ç§’ï¼‰\n2. è¯·ç¡®ä¿å·²ä¿å­˜æ‰€æœ‰é…ç½®\n3. Docker/PM2 ä¼šè‡ªåŠ¨é‡å¯ï¼Œç›´æ¥è¿è¡Œ node éœ€è¦æ‰‹åŠ¨é‡å¯')) {
                return;
            }

            try {
                showStatus('æ­£åœ¨é‡å¯æœåŠ¡ï¼Œè¯·ç¨å€™...', 'success');

                const response = await fetch('/api/restart', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('æœåŠ¡é‡å¯ä¸­...è¯·ç­‰å¾…çº¦ 5-10 ç§’ååˆ·æ–°é¡µé¢', 'success');
                    
                    // 15ç§’åè‡ªåŠ¨åˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        location.reload();
                    }, 15000);
                } else {
                    showStatus(result.message || 'é‡å¯å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('é‡å¯è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = loadData;
    </script>
</body>
</html>
