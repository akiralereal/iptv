<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV é¢‘é“ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            padding: 8px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            border-bottom: 2px solid #f0f0f0;
            justify-content: space-between;
            align-items: center;
        }

        .tabs-left {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1;
            justify-content: center;
        }

        .tabs-right {
            display: flex;
            gap: 8px;
            align-items: center;
            padding-right: 10px;
        }

        .restart-btn {
            padding: 8px 16px;
            background: #52c41a;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .restart-btn:hover {
            background: #73d13d;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            color: #666;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab:hover {
            color: #1890ff;
            background: #f5f5f5;
        }

        .tab.active {
            color: #1890ff;
            border-bottom-color: #1890ff;
            font-weight: 600;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #1890ff;
            color: white;
        }

        .btn-primary:hover {
            background: #40a9ff;
        }

        .btn-success {
            background: #52c41a;
            color: white;
        }

        .btn-success:hover {
            background: #73d13d;
        }

        .btn-danger {
            background: #ff4d4f;
            color: white;
        }

        .main-content {
            margin-top: 0;
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 8px;
        }

        .search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .channels-container {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
            height: calc(100vh - 250px);
        }

        .category-sidebar {
            border-right: 2px solid #f0f0f0;
            padding-right: 15px;
            overflow-y: auto;
            height: 100%;
        }

        .category-nav-item {
            padding: 10px 15px;
            margin-bottom: 5px;
            background: #fafafa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: #333;
            border-left: 3px solid transparent;
        }

        .category-nav-item:hover {
            background: #e6f7ff;
            border-left-color: #40a9ff;
        }

        .category-nav-item.active {
            background: #e6f7ff;
            border-left-color: #1890ff;
            color: #1890ff;
            font-weight: 600;
        }

        .category-nav-item .count {
            float: right;
            color: #999;
            font-size: 12px;
        }

        .channels-content {
            overflow-y: auto;
            height: 100%;
        }

        .channel-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .channel-item {
            padding: 12px;
            background: #fafafa;
            border-radius: 4px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            font-size: 14px;
            border: 1px solid transparent;
        }

        .channel-item:hover {
            background: #e6f7ff;
            border-color: #1890ff;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.2);
        }

        .custom-groups {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .group {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-bottom: 15px;
            padding: 15px;
            background: #fafafa;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .group-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .group-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .group-channels {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .channel-tag {
            padding: 6px 12px;
            background: white;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .channel-tag .remove {
            color: #ff4d4f;
            cursor: pointer;
            font-weight: bold;
        }

        .channel-tag .remove:hover {
            color: #ff7875;
        }

        .empty-group {
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 400px;
        }

        .modal-content h3 {
            margin-bottom: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            min-width: 300px;
            max-width: 500px;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .status.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .status.success {
            background: #f6ffed;
            border: 1px solid #52c41a;
            color: #52c41a;
        }

        .status.error {
            background: #fff2f0;
            border: 1px solid #ff4d4f;
            color: #ff4d4f;
        }

        .external-panel {
            margin-top: 20px;
        }

        .external-usage {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 12px;
            font-size: 13px;
            line-height: 1.8;
        }

        .external-usage h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #1890ff;
        }

        .external-usage ol {
            margin: 0;
            padding-left: 20px;
            color: #595959;
        }

        .external-usage li {
            margin-bottom: 4px;
        }

        .external-header {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .external-container {
            display: grid;
            grid-template-columns: 250px 1fr 280px;
            gap: 20px;
            height: calc(100vh - 250px);
        }

        .external-sidebar {
            border-right: 2px solid #f0f0f0;
            padding-right: 15px;
            overflow-y: auto;
            height: 100%;
        }

        .external-nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            background: #fafafa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            position: relative;
        }

        .external-nav-item:hover {
            background: #e6f7ff;
            border-left-color: #40a9ff;
        }

        .external-nav-item.active {
            background: #e6f7ff;
            border-left-color: #1890ff;
            font-weight: 600;
        }

        .external-nav-title {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .external-nav-item.active .external-nav-title {
            color: #1890ff;
        }

        .external-nav-meta {
            font-size: 11px;
            color: #999;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .external-mode-badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 11px;
            border-radius: 3px;
            font-weight: 500;
        }

        .external-mode-badge.fetch {
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }

        .external-mode-badge.direct {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .external-detail {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .external-usage-side {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 13px;
            line-height: 1.8;
            overflow-y: auto;
            height: 100%;
        }

        .external-usage-side h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #1890ff;
        }

        .external-usage-side ol {
            margin: 0;
            padding-left: 20px;
            color: #595959;
        }

        .external-usage-side li {
            margin-bottom: 8px;
        }

        .external-detail-header {
            padding: 16px 20px;
            background: #fafafa;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .external-detail-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .external-detail-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .external-detail-footer {
            padding: 16px 20px;
            background: #fafafa;
            border-top: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .external-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            font-size: 14px;
            text-align: center;
        }

        .external-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 16px;
            max-height: calc(100vh - 380px);
            overflow-y: auto;
            padding: 4px;
        }

        .external-item {
            border: 1px solid #d9d9d9;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        .external-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .external-item-header {
            padding: 12px 16px;
            background: #f5f5f5;
            border-bottom: 1px solid #e8e8e8;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .external-item-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .external-item-status {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-badge.enabled {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .status-badge.disabled {
            background: #f5f5f5;
            color: #999;
            border: 1px solid #d9d9d9;
        }

        .mode-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
            margin-left: 8px;
        }

        .mode-badge.mode-direct {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .mode-switcher {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: #fafafa;
            border-bottom: 1px solid #e8e8e8;
        }

        .mode-switch-btn {
            padding: 6px 16px;
            border: 1px solid #d9d9d9;
            background: white;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
        }

        .mode-switch-btn:hover {
            border-color: #40a9ff;
            color: #40a9ff;
        }

        .mode-switch-btn.active {
            background: #1890ff;
            border-color: #1890ff;
            color: white;
            font-weight: 500;
        }

        .external-item-body {
            padding: 16px;
            flex: 1;
        }

        .external-field {
            margin-bottom: 12px;
        }

        .external-field:last-child {
            margin-bottom: 0;
        }

        .external-field label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .external-field input[type="text"],
        .external-field input[type="number"],
        .external-field select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
            transition: all 0.3s;
        }

        .external-field input:focus,
        .external-field select:focus {
            border-color: #1890ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }

        .external-field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-hint {
            margin-top: 4px;
            font-size: 11px;
            color: #999;
            line-height: 1.4;
        }

        .external-item-footer {
            padding: 12px 16px;
            background: #fafafa;
            border-top: 1px solid #e8e8e8;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .external-switches {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .external-switches label {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        .external-switches input[type="checkbox"] {
            margin-right: 4px;
        }

        .external-actions {
            display: flex;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                flex-direction: column;
                gap: 12px;
            }

            .tabs-left {
                width: 100%;
                overflow-x: auto;
            }

            .tabs-right {
                width: 100%;
                justify-content: center;
                padding-right: 0;
            }

            .restart-btn {
                width: 100%;
            }
            
            .tab {
                white-space: nowrap;
                flex-shrink: 0;
            }

            .external-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .external-sidebar {
                border-right: none;
                border-bottom: 2px solid #f0f0f0;
                padding-right: 0;
                padding-bottom: 10px;
                margin-bottom: 15px;
                max-height: 150px;
                height: auto;
            }

            .external-usage-side {
                display: none;
            }

            .external-detail {
                height: auto;
                min-height: 400px;
            }

            .external-field-row {
                grid-template-columns: 1fr;
            }

            .channels-container {
                grid-template-columns: 1fr;
            }

            .category-sidebar {
                border-right: none;
                border-bottom: 2px solid #f0f0f0;
                padding-right: 0;
                padding-bottom: 10px;
                margin-bottom: 15px;
                max-height: 150px;
            }

            .system-config-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .system-config-item {
                margin-bottom: 0;
            }
        }

        .system-config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 24px;
            margin-bottom: 20px;
        }

        .system-config-item {
            margin-bottom: 0;
        }

        .system-config-item label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .system-config-item input[type="text"],
        .system-config-item input[type="number"],
        .system-config-item select {
            width: 100%;
            padding: 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
        }

        .system-config-item input[type="checkbox"] {
            margin-right: 6px;
        }

        .system-config-hint {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .system-config-warning {
            background: #fff7e6;
            border: 1px solid #ffd666;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 15px;
            color: #ad6800;
            font-size: 13px;
        }

        .bookmarklet-section {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .bookmarklet-title {
            font-size: 14px;
            font-weight: 600;
            color: #1890ff;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bookmarklet-link {
            display: inline-block;
            background: #1890ff;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            cursor: move;
            transition: all 0.3s;
            border: 2px dashed transparent;
        }

        .bookmarklet-link:hover {
            background: #40a9ff;
            border-color: #fff;
           transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(24, 144, 255, 0.3);
        }
        
        .bookmarklet-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .bookmarklet-help-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #fff;
            border: 2px solid #1890ff;
            border-radius: 50%;
            color: #1890ff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .bookmarklet-help-btn:hover {
            background: #1890ff;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
        }

        .bookmarklet-steps {
            margin-top: 12px;
            font-size: 12px;
            color: #595959;
            line-height: 1.8;
        }

        .bookmarklet-steps ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .bookmarklet-steps li {
            margin-bottom: 6px;
        }

        .bookmarklet-steps strong {
            color: #1890ff;
        }

        .system-config-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
        }

        .btn-warning {
            background: #faad14;
            color: white;
        }

        .btn-warning:hover {
            background: #ffc53d;
        }
        /* è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .confirm-overlay.show {
            display: flex;
        }

        .confirm-dialog {
            background: white;
            border-radius: 8px;
            padding: 24px;
            min-width: 350px;
            max-width: 500px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            animation: confirmSlideIn 0.2s ease-out;
        }

        @keyframes confirmSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .confirm-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .confirm-message {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .confirm-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirm-btn-cancel {
            background: #f0f0f0;
            color: #333;
        }

        .confirm-btn-cancel:hover {
            background: #e0e0e0;
        }

        .confirm-btn-confirm {
            background: #1890ff;
            color: white;
        }

        .confirm-btn-confirm:hover {
            background: #40a9ff;
        }

        /* æˆ‘çš„é¢‘é“æ ·å¼ */
        .my-playlist-header {
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .my-playlist-info h3 {
            margin: 0;
            color: #333;
        }

        .my-playlist-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .my-playlist-info code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .my-playlist-actions {
            display: flex;
            gap: 10px;
        }

        .my-playlist-container {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .my-playlist-left {
            width: 220px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .my-playlist-middle {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }

        .my-playlist-right {
            width: 220px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .my-playlist-section {
            display: flex;
            flex-direction: column;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
            overflow: hidden;
            height: 100%;
        }

        .my-playlist-section-title {
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 14px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .my-playlist-section-title button {
            padding: 4px 10px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .my-playlist-section-title button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .my-playlist-section.deleted-section .my-playlist-section-title {
            background: linear-gradient(135deg, #868686 0%, #5a5a5a 100%);
        }

        .my-playlist-group-list {
            overflow-y: auto;
            flex: 1;
            padding: 8px;
        }

        .my-playlist-group-item {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .my-playlist-group-item:hover {
            background: #f0f0f0;
            border-color: #667eea;
            transform: translateX(2px);
        }

        .my-playlist-group-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .my-playlist-group-item.deleted {
            background: #f5f5f5;
            color: #333;
            border-color: #ccc;
        }

        .my-playlist-group-item.deleted:hover {
            background: #e8e8e8;
            color: #000;
        }

        .my-playlist-detail-header {
            padding: 15px 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .my-playlist-detail-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .my-playlist-detail-actions button {
            margin-left: 8px;
        }

        .my-playlist-groups {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
            overflow-y: auto;
            padding: 0 5px;
        }

        .my-playlist-group {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
        }

        .my-playlist-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .my-playlist-group-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .my-playlist-group-actions {
            display: flex;
            gap: 8px;
        }

        .my-playlist-group-actions button {
            padding: 4px 12px;
            font-size: 13px;
        }

        .my-playlist-channels {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .my-playlist-channel {
            padding: 8px 12px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .my-playlist-channel.batch-mode {
            cursor: default;
        }

        .my-playlist-channel-checkbox {
            margin-right: 8px;
            cursor: pointer;
        }

        .my-playlist-channel:hover {
            background: #f0f8ff;
            border-color: #1890ff;
        }

        .my-playlist-channel-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #333;
            font-weight: 500;
        }

        .my-playlist-channel-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .my-playlist-channel:hover .my-playlist-channel-actions {
            opacity: 1;
        }

        .my-playlist-channel.deleted .my-playlist-channel-actions {
            opacity: 1;
        }

        .my-playlist-channel-actions button {
            padding: 2px 6px;
            font-size: 12px;
            background: transparent;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            color: #333;
        }

        .my-playlist-channel-actions button.btn-primary {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }

        .my-playlist-channel-actions button.btn-primary:hover {
            background: #40a9ff;
            border-color: #40a9ff;
        }

        .my-playlist-channel-actions button:hover {
            background: #f5f5f5;
        }

    </style>
</head>
<body>
    <!-- è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-dialog">
            <div class="confirm-title" id="confirmTitle">localhost:1905 æ˜¾ç¤º</div>
            <div class="confirm-message" id="confirmMessage">ç¡®è®¤è¦åˆ é™¤è¿™ä¸ªå¤–éƒ¨æºå—ï¼Ÿ</div>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-btn-cancel" onclick="hideConfirm(false)">å–æ¶ˆ</button>
                <button class="confirm-btn confirm-btn-confirm" onclick="hideConfirm(true)">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <!-- Toast é€šçŸ¥ -->
    <div class="status" id="status"></div>
    
    <!-- é¢‘é“è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="channelDetailModal">
        <div class="modal-content" style="width: 600px; max-width: 90%;">
            <h3 id="channelDetailTitle">é¢‘é“è¯¦æƒ…</h3>
            <div id="channelDetailContent" style="max-height: 500px; overflow-y: auto;">
                <!-- åŠ¨æ€å†…å®¹å°†åœ¨è¿™é‡Œæ’å…¥ -->
            </div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeChannelDetail()">å…³é—­</button>
                <button class="btn btn-primary" id="channelDetailEditBtn" style="display: none;" onclick="editChannelFromDetail()">ç¼–è¾‘</button>
            </div>
        </div>
    </div>
    
    <!-- Bookmarklet æ·»åŠ å¼•å¯¼å¼¹çª— -->
    <div class="modal" id="bookmarkletGuideModal">
        <div class="modal-content" style="width: 700px; max-width: 90%;">
            <h3 style="margin-bottom: 20px;">ğŸ“– å¦‚ä½•æ·»åŠ å’ªå’•è´¦å·è·å–å·¥å…·</h3>
            
            <div style="background: #e6f7ff; border: 1px solid #91d5ff; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                <h4 style="color: #1890ff; margin-bottom: 12px;">æ–¹æ³•ä¸€ï¼šæ‹–æ‹½æ·»åŠ ï¼ˆæ¨èï¼‰</h4>
                <ol style="line-height: 1.8; padding-left: 20px;">
                    <li>é¼ æ ‡<strong>æŒ‰ä½</strong>è“è‰²æŒ‰é’®ä¸æ¾å¼€</li>
                    <li><strong>æ‹–æ‹½</strong>åˆ°æµè§ˆå™¨é¡¶éƒ¨çš„ä¹¦ç­¾æ </li>
                    <li>æ¾å¼€é¼ æ ‡ï¼Œä¹¦ç­¾æ·»åŠ å®Œæˆ</li>
                </ol>
            </div>
            
            <div style="background: #fff7e6; border: 1px solid #ffd591; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                <h4 style="color: #fa8c16; margin-bottom: 12px;">æ–¹æ³•äºŒï¼šæ‰‹åŠ¨åˆ›å»ºä¹¦ç­¾</h4>
                <ol style="line-height: 1.8; padding-left: 20px;">
                    <li>åœ¨æµè§ˆå™¨ä¹¦ç­¾æ <strong>å³é”®</strong> â†’ é€‰æ‹©"æ·»åŠ ç½‘é¡µ"æˆ–"æ–°å»ºä¹¦ç­¾"</li>
                    <li>åç§°å¡«å†™ï¼š<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">è·å–å’ªå’•è´¦å·</code></li>
                    <li>ç½‘å€/URL å¡«å†™ä¸‹æ–¹çš„ä»£ç ï¼ˆç‚¹å‡»æŒ‰é’®è‡ªåŠ¨å¤åˆ¶ï¼‰</li>
                </ol>
                <div style="margin-top: 12px;">
                    <button class="btn btn-primary" onclick="copyBookmarkletCode()" style="width: 100%;">
                        ğŸ“‹ å¤åˆ¶ Bookmarklet ä»£ç 
                    </button>
                </div>
            </div>
            
            <div style="background: #f6ffed; border: 1px solid #b7eb8f; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 13px; color: #52c41a;">
                <strong>âœ“ æ·»åŠ æˆåŠŸåï¼š</strong>åœ¨å’ªå’•è§†é¢‘ç½‘ç«™ç‚¹å‡»ä¹¦ç­¾ï¼Œå³å¯è‡ªåŠ¨æå–å¹¶å¤åˆ¶è´¦å·ä¿¡æ¯
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeBookmarkletGuide()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- æ’­æ”¾å™¨ä¸‹è½½æç¤ºå¼¹çª— -->
    <div class="modal" id="playerDownloadModal">
        <div class="modal-content" style="width: 500px; max-width: 90%;">
            <h3 style="margin-bottom: 20px;">âš ï¸ æ’­æ”¾å™¨æœªå®‰è£…</h3>
            
            <div style="background: #fff7e6; border: 1px solid #ffd591; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                <p style="line-height: 1.8; margin: 0; font-size: 15px;">
                    æ— æ³•è¯†åˆ«åˆ°é»˜è®¤å¯æ’­æ”¾è®¾å¤‡ï¼Œæ‚¨å¯ä»¥å…ˆä¸‹è½½æ’­æ”¾è½¯ä»¶ã€‚
                </p>
                <p style="line-height: 1.8; margin: 12px 0 0 0; font-size: 14px; color: #666;">
                    æ¨èæ’­æ”¾å™¨ï¼š<span id="recommendedPlayer" style="font-weight: bold;"></span>
                </p>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn" onclick="closePlayerDownloadModal()" style="background: #eee; color: #333;">å…³é—­</button>
                <button class="btn btn-primary" onclick="goToPlayerDownload()">ğŸ”½ å»ä¸‹è½½</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="tabs">
                <div class="tabs-left">
                    <button class="tab active" onclick="switchTab(0)">ğŸ“º æˆ‘çš„é¢‘é“</button>
                    <button class="tab" onclick="switchTab(1)">ğŸŒ æºç®¡ç†</button>
                    <button class="tab" onclick="switchTab(2)">âš™ï¸ ç³»ç»Ÿé…ç½®</button>
                    <button class="tab" onclick="switchTab(3)">â„¹ï¸ å…³äºæˆ‘ä»¬</button>
                </div>
                <div class="tabs-right">
                    <button class="restart-btn" onclick="restartService()">ğŸ”„ é‡å¯æœåŠ¡</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel active">
                <div class="my-playlist-header">
                    <div class="my-playlist-info">
                        <h3>ğŸ“º æˆ‘çš„é¢‘é“</h3>
                    </div>
                    <div class="my-playlist-actions">
                        <button class="btn btn-success" onclick="saveMyPlaylist()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                        <button class="btn btn-warning" onclick="resetMyPlaylist()">ğŸ”„ é‡ç½®</button>
                    </div>
                </div>
                <div class="my-playlist-container">
                    <div class="my-playlist-left">
                        <div class="my-playlist-section">
                            <div class="my-playlist-section-title">
                                <span>âœ… æˆ‘çš„é¢‘é“</span>
                            </div>
                            <div class="my-playlist-group-list" id="activeGroupList"></div>
                        </div>
                    </div>
                    <div class="my-playlist-middle">
                        <div class="my-playlist-detail-header" id="detailHeader" style="display: none;">
                            <div class="my-playlist-detail-title" id="detailTitle"></div>
                            <div class="my-playlist-detail-actions" id="detailActions"></div>
                        </div>
                        <div class="my-playlist-groups" id="myPlaylistGroups"></div>
                    </div>
                    <div class="my-playlist-right">
                        <div class="my-playlist-section">
                            <div class="my-playlist-section-title"><span>ğŸš« å·²éšè—</span></div>
                            <div class="my-playlist-group-list" id="deletedGroupList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="external-header">
                    <button class="btn btn-primary" onclick="addExternalSource()">â¥ æ·»åŠ æº</button>
                </div>
                <div class="external-container">
                    <div class="external-sidebar">
                        <div style="padding: 8px 12px; background: #f6ffed; border-left: 3px solid #52c41a; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;">
                            <span style="font-weight: 600; color: #52c41a;">ğŸ‘¤ è‡ªå®šä¹‰æº</span>
                            <span id="externalSourceCount" style="font-size: 12px; color: #666;"></span>
                        </div>
                        <div id="externalSourceList"></div>
                    </div>
                    <div class="external-detail" id="externalDetail">
                        <div class="external-empty">è¯·åœ¨å·¦ä¾§é€‰æ‹©æˆ–æ·»åŠ æº</div>
                    </div>
                    <div class="external-usage-side">
                        <h4>ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
                        <div style="background: #f6ffed; padding: 12px; border-radius: 4px; margin-bottom: 15px;">
                            <strong style="color: #52c41a;">ğŸ‘¤ è‡ªå®šä¹‰æºé…ç½®</strong>
                            <ol style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: #666; line-height: 1.8;">
                                <li>ç‚¹å‡»"æ·»åŠ æº"é€‰æ‹©æ¨¡å¼ï¼š<strong>æŠ“å–æ¨¡å¼</strong>æˆ–<strong>ç›´è¿æ¨¡å¼</strong></li>
                                <li><strong>æŠ“å–æ¨¡å¼</strong>ï¼šå¡«å†™é¢‘é“åã€åˆ†ç»„å’Œç½‘é¡µåœ°å€ï¼Œç‚¹å‡»"æŠ“å–å¹¶ä¿å­˜"</li>
                                <li><strong>ç›´è¿æ¨¡å¼</strong>ï¼šå¡«å†™é¢‘é“åã€åˆ†ç»„å’Œm3u8é“¾æ¥ï¼Œç‚¹å‡»"ä¿å­˜"</li>
                                <li>å¯ç¼–è¾‘ã€åˆ é™¤ã€å¯ç”¨/ç¦ç”¨</li>
                                <li>è®¾ç½®è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼ˆé»˜è®¤4å°æ—¶ï¼‰</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="system-config-warning">
                    âš ï¸ ä¿®æ”¹ç³»ç»Ÿé…ç½®åéœ€è¦<strong>é‡å¯æœåŠ¡</strong>æ‰èƒ½ç”Ÿæ•ˆ
                </div>
                
                <div class="bookmarklet-section">
                    <div class="bookmarklet-title">
                        <span>ğŸ“–</span>
                        <span>å¿«é€Ÿè·å–å’ªå’•è´¦å·ä¿¡æ¯</span>
                    </div>
                    <div class="bookmarklet-actions">
                        <a id="miguBookmarklet" class="bookmarklet-link" draggable="true">
                            ğŸ“– è·å–å’ªå’•è´¦å·
                        </a>
                        <button class="bookmarklet-help-btn" onclick="openBookmarkletGuide()" title="æŸ¥çœ‹ä½¿ç”¨è¯´æ˜">
                            ?
                        </button>
                    </div>
                </div>
                
                <div class="system-config-grid">
                    <div class="system-config-item">
                        <label>å’ªå’•ç”¨æˆ·ID</label>
                        <input type="text" id="sysUserId" placeholder="ç•™ç©ºä¸ºæ¸¸å®¢æ¨¡å¼">
                        <div class="system-config-hint">VIPç”¨æˆ·å¡«å†™ï¼Œæ¸¸å®¢æ¨¡å¼å¯ç•™ç©º</div>
                    </div>
                    <div class="system-config-item">
                        <label>å’ªå’•Token</label>
                        <input type="text" id="sysToken" placeholder="ç•™ç©ºä¸ºæ¸¸å®¢æ¨¡å¼">
                        <div class="system-config-hint">VIPç”¨æˆ·å¡«å†™ï¼Œæ¸¸å®¢æ¨¡å¼å¯ç•™ç©º</div>
                    </div>
                    <div class="system-config-item">
                        <label>ç”»è´¨</label>
                        <select id="sysRateType">
                            <option value="2">æ ‡æ¸… (480p)</option>
                            <option value="3">é«˜æ¸… (720p)</option>
                            <option value="4">è“å…‰ (1080p Â· éœ€VIP)</option>
                            <option value="7">åŸç”» (1080p+ Â· éœ€VIP)</option>
                            <option value="9">4K (2160p Â· éœ€VIP)</option>
                        </select>
                        <div class="system-config-hint">720påŠä»¥ä¸‹å…è´¹ï¼Œæ›´é«˜ç”»è´¨éœ€è¦VIP</div>
                    </div>
                    <div class="system-config-item">
                        <label>æœåŠ¡ç«¯å£</label>
                        <input type="number" id="sysPort" placeholder="1905">
                    </div>
                    <div class="system-config-item">
                        <label>å…¬ç½‘åœ°å€</label>
                        <input type="text" id="sysHost" placeholder="http://example.com:xxxx">
                        <div class="system-config-hint">é€‰å¡«ï¼ŒæœªæŒ‡å®šç«¯å£æ—¶è‡ªåŠ¨ä½¿ç”¨ä¸Šæ–¹çš„æœåŠ¡ç«¯å£</div>
                    </div>
                    <div class="system-config-item">
                        <label>è®¿é—®å¯†ç </label>
                        <input type="text" id="sysPass" placeholder="ç•™ç©ºè¡¨ç¤ºæ— å¯†ç ">
                        <div class="system-config-hint">è®¾ç½®åè®¿é—®æ ¼å¼ï¼šhttp://ip:port/å¯†ç /...</div>
                    </div>
                    <div class="system-config-item" style="display: none;">
                        <label>èŠ‚ç›®å•æ›´æ–°é—´éš”ï¼ˆå°æ—¶ï¼‰</label>
                        <input type="number" id="sysProgramInterval" placeholder="6">
                    </div>
                    <div class="system-config-item" style="display: none;">
                        <label>
                            <input type="checkbox" id="sysEnableHDR">
                            å¯ç”¨ HDR
                        </label>
                    </div>
                    <div class="system-config-item" style="display: none;">
                        <label>
                            <input type="checkbox" id="sysEnableH265">
                            å¯ç”¨ H.265ï¼ˆå¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼‰
                        </label>
                    </div>
                </div>
                <div class="system-config-actions">
                    <button class="btn btn-success" onclick="saveSystemConfig()">ğŸ’¾ ä¿å­˜ç³»ç»Ÿé…ç½®</button>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: #f0f0f0; border-radius: 4px; font-size: 13px; color: #666; text-align: center;">
                    ğŸ’¡ æç¤ºï¼šä¿å­˜é…ç½®åï¼Œéœ€ç‚¹å‡»é¡µé¢é¡¶éƒ¨çš„"é‡å¯æœåŠ¡"æŒ‰é’®ä½¿æ–°é…ç½®ç”Ÿæ•ˆ
                </div>
            </div>
            
            <!-- å…³äºæˆ‘ä»¬é¢æ¿ -->
            <div class="panel">
                <div style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h2 style="color: #1890ff; font-size: 32px; margin-bottom: 10px;">ğŸ“¡ IPTV ç®¡ç†ç³»ç»Ÿ</h2>
                        <p style="color: #666; font-size: 16px;">åŸºäº Node.js çš„ IPTV ç›´æ’­æºç®¡ç†å’Œåˆ†å‘ç³»ç»Ÿ</p>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <div style="margin-bottom: 25px;">
                            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                <span style="color: #1890ff; font-size: 20px; margin-right: 10px;">ğŸ”—</span>
                                <strong style="color: #333; font-size: 16px;">é¡¹ç›®åœ°å€</strong>
                            </div>
                            <div style="padding-left: 30px;">
                                <a href="https://github.com/akiralereal/iptv" target="_blank" 
                                   style="color: #1890ff; text-decoration: none; font-size: 15px; word-break: break-all;">
                                    https://github.com/akiralereal/iptv
                                </a>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                <span style="color: #1890ff; font-size: 20px; margin-right: 10px;">ğŸŒ</span>
                                <strong style="color: #333; font-size: 16px;">äº†è§£æ›´å¤š</strong>
                            </div>
                            <div style="padding-left: 30px;">
                                <a href="https://ifansclub.com/" target="_blank" 
                                   style="color: #1890ff; text-decoration: none; font-size: 15px; word-break: break-all;">
                                    https://ifansclub.com/
                                </a>
                            </div>
                        </div>
                        
                        <div>
                            <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                <span style="color: #1890ff; font-size: 20px; margin-right: 10px;">ğŸ“§</span>
                                <strong style="color: #333; font-size: 16px;">è”ç³»é‚®ç®±</strong>
                            </div>
                            <div style="padding-left: 30px;">
                                <a href="mailto:contact@ifansclub.com" 
                                   style="color: #1890ff; text-decoration: none; font-size: 15px; word-break: break-all;">
                                    contact@ifansclub.com
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; color: #999; font-size: 14px; padding: 20px 0;">
                        <p style="margin: 0;">â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ Star æ”¯æŒæˆ‘ä»¬ï¼</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allChannels = [];
        let externalConfig = {
            enabled: false,
            includeInPlaylists: true,
            sources: []
        };
        let builtInConfig = {
            enabled: true,
            sources: []
        };
        let systemConfig = {};
        let updatingSourceIndex = null; // è®°å½•æ­£åœ¨æ›´æ–°çš„æºç´¢å¼•

        // Tab åˆ‡æ¢åŠŸèƒ½
        async function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const panels = document.querySelectorAll('.panel');
            
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            panels.forEach((panel, i) => {
                if (i === index) {
                    panel.classList.add('active');
                } else {
                    panel.classList.remove('active');
                }
            });
            
            // åˆ‡æ¢åˆ°æˆ‘çš„é¢‘é“Tabæ—¶åŠ è½½æ•°æ®
            if (index === 0) {
                // é‡ç½®é€‰ä¸­çŠ¶æ€
                selectedGroupIndex = 0;
                isViewingDeleted = false;
                await loadMyPlaylist();
            }
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                console.log('å¼€å§‹åŠ è½½æ•°æ®...');
                
                // åŠ è½½æ‰€æœ‰é¢‘é“
                console.log('è¯·æ±‚é¢‘é“åˆ—è¡¨...');
                const channelsRes = await fetch('/api/channels');
                if (!channelsRes.ok) {
                    throw new Error(`é¢‘é“APIè¯·æ±‚å¤±è´¥: ${channelsRes.status}`);
                }
                allChannels = await channelsRes.json();
                console.log('é¢‘é“æ•°æ®åŠ è½½æˆåŠŸ:', allChannels.length, 'ä¸ªåˆ†ç»„');
                
                // åŠ è½½å¤–éƒ¨æºé…ç½®
                console.log('è¯·æ±‚å¤–éƒ¨æºé…ç½®...');
                const externalRes = await fetch('/api/external-sources');
                if (!externalRes.ok) {
                    throw new Error(`å¤–éƒ¨æºAPIè¯·æ±‚å¤±è´¥: ${externalRes.status}`);
                }
                const externalPayload = await externalRes.json();
                externalConfig = normalizeExternalConfig(externalPayload);
                console.log('å¤–éƒ¨æºé…ç½®åŠ è½½æˆåŠŸ:', externalConfig.sources?.length || 0, 'ä¸ªæº');
                
                // åŠ è½½å†…ç½®æºé…ç½®
                console.log('è¯·æ±‚å†…ç½®æºé…ç½®...');
                const builtInRes = await fetch('/api/built-in-sources');
                if (!builtInRes.ok) {
                    throw new Error(`å†…ç½®æºAPIè¯·æ±‚å¤±è´¥: ${builtInRes.status}`);
                }
                const builtInPayload = await builtInRes.json();
                builtInConfig = builtInPayload.data || { enabled: true, sources: [] };
                console.log('å†…ç½®æºé…ç½®åŠ è½½æˆåŠŸ:', builtInConfig.sources?.length || 0, 'ä¸ªæº');
                
                // åŠ è½½ç³»ç»Ÿé…ç½®
                console.log('è¯·æ±‚ç³»ç»Ÿé…ç½®...');
                const systemRes = await fetch('/api/system-config');
                if (!systemRes.ok) {
                    throw new Error(`ç³»ç»Ÿé…ç½®APIè¯·æ±‚å¤±è´¥: ${systemRes.status}`);
                }
                systemConfig = await systemRes.json();
                console.log('ç³»ç»Ÿé…ç½®åŠ è½½æˆåŠŸ');
                
                // åŠ è½½æˆ‘çš„é¢‘é“é…ç½®
                console.log('è¯·æ±‚æˆ‘çš„é¢‘é“é…ç½®...');
                await loadMyPlaylistConfig();
                console.log('æˆ‘çš„é¢‘é“é…ç½®åŠ è½½æˆåŠŸ');
                
                // æ¸²æŸ“æ‰€æœ‰å†…å®¹
                console.log('å¼€å§‹æ¸²æŸ“é¡µé¢...');
                // renderChannels(); // å·²ç§»é™¤æ‰€æœ‰é¢‘é“UI
                await loadMyPlaylist(); // åŠ è½½æˆ‘çš„é¢‘é“æ•°æ®ï¼ˆå› ä¸ºé»˜è®¤æ˜¾ç¤ºæ­¤tabï¼‰
                renderExternalSources();
                renderSystemConfig();
                initMiguBookmarklet(); // åˆå§‹åŒ–å’ªå’•è´¦å·è·å–å·¥å…·
                console.log('é¡µé¢æ¸²æŸ“å®Œæˆ');
                
                showStatus('æ•°æ®åŠ è½½æˆåŠŸ', 'success');
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showStatus('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
                // å³ä½¿å¤±è´¥ä¹Ÿå°è¯•æ¸²æŸ“ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                // renderChannels(); // å·²ç§»é™¤æ‰€æœ‰é¢‘é“UI
                renderExternalSources();
            }
        }

        let currentCategory = 'all'; // å½“å‰é€‰ä¸­çš„åˆ†ç»„
        let selectedExternalIndex = null; // å½“å‰é€‰ä¸­çš„å¤–éƒ¨æºç´¢å¼•

        // æ¸²æŸ“é¢‘é“åˆ—è¡¨
        function renderChannels() {
            const channelContainer = document.getElementById('channelList');
            const categoryContainer = document.getElementById('categorySidebar');
            
            // æ·»åŠ DOMå…ƒç´ å®‰å…¨æ£€æŸ¥
            if (!channelContainer || !categoryContainer) {
                console.error('é¢‘é“åˆ—è¡¨ç›¸å…³DOMå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            if (!allChannels || allChannels.length === 0) {
                channelContainer.innerHTML = '<div class="empty-group" style="grid-column: 1/-1;">æš‚æ— é¢‘é“æ•°æ®<br><br>å¯èƒ½åŸå› ï¼š<br>1. æœåŠ¡åˆšå¯åŠ¨ï¼Œæ•°æ®æ­£åœ¨åŠ è½½ä¸­...<br>2. æœªé…ç½®å’ªå’•è´¦å·ï¼ˆè¯·åœ¨"ç³»ç»Ÿé…ç½®"ä¸­å¡«å†™ï¼‰<br>3. ç½‘ç»œè¿æ¥é—®é¢˜</div>';
                console.log('é¢‘é“æ•°æ®ä¸ºç©º:', allChannels);
                return;
            }
            
            console.log(`æ­£åœ¨æ¸²æŸ“ ${allChannels.length} ä¸ªé¢‘é“åˆ†ç»„`);
            
            // æ¸²æŸ“å·¦ä¾§åˆ†ç»„å¯¼èˆª
            categoryContainer.innerHTML = '';
            
            // æ·»åŠ "å…¨éƒ¨"é€‰é¡¹
            const totalCount = allChannels.reduce((sum, cat) => sum + (cat.dataList ? cat.dataList.length : 0), 0);
            const allItem = document.createElement('div');
            allItem.className = 'category-nav-item' + (currentCategory === 'all' ? ' active' : '');
            allItem.innerHTML = `å…¨éƒ¨<span class="count">${totalCount}</span>`;
            allItem.onclick = () => selectCategory('all');
            categoryContainer.appendChild(allItem);
            
            // æ·»åŠ å„ä¸ªåˆ†ç»„
            allChannels.forEach((category, index) => {
                if (!category.dataList || category.dataList.length === 0) return;
                
                const navItem = document.createElement('div');
                navItem.className = 'category-nav-item' + (currentCategory === index ? ' active' : '');
                navItem.innerHTML = `${category.name}<span class="count">${category.dataList.length}</span>`;
                navItem.onclick = () => selectCategory(index);
                categoryContainer.appendChild(navItem);
            });
            
            // æ¸²æŸ“å³ä¾§é¢‘é“åˆ—è¡¨
            renderChannelList();
        }

        function selectCategory(categoryIndex) {
            currentCategory = categoryIndex;
            
            // æ›´æ–°åˆ†ç»„é«˜äº®
            document.querySelectorAll('.category-nav-item').forEach((item, index) => {
                if (categoryIndex === 'all' && index === 0) {
                    item.classList.add('active');
                } else if (categoryIndex === index - 1) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // æ¸²æŸ“é¢‘é“åˆ—è¡¨
            renderChannelList();
        }

        function renderChannelList() {
            const container = document.getElementById('channelList');
            
            // æ·»åŠ DOMå…ƒç´ å®‰å…¨æ£€æŸ¥
            if (!container) {
                console.error('channelList å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            container.innerHTML = '';
            
            if (currentCategory === 'all') {
                // æ˜¾ç¤ºæ‰€æœ‰é¢‘é“
                allChannels.forEach(category => {
                    if (!category.dataList || category.dataList.length === 0) return;
                    
                    category.dataList.forEach(channel => {
                        const channelDiv = document.createElement('div');
                        channelDiv.className = 'channel-item';
                        channelDiv.innerHTML = channel.name;
                        channelDiv.dataset.categoryName = category.name;
                        channelDiv.dataset.channelName = channel.name;
                        container.appendChild(channelDiv);
                    });
                });
            } else {
                // æ˜¾ç¤ºç‰¹å®šåˆ†ç»„çš„é¢‘é“
                const category = allChannels[currentCategory];
                if (category && category.dataList) {
                    category.dataList.forEach(channel => {
                        const channelDiv = document.createElement('div');
                        channelDiv.className = 'channel-item';
                        channelDiv.innerHTML = channel.name;
                        channelDiv.dataset.categoryName = category.name;
                        channelDiv.dataset.channelName = channel.name;
                        container.appendChild(channelDiv);
                    });
                }
            }
        }

        // æœç´¢é¢‘é“
        function filterChannels() {
            const keyword = document.getElementById('searchBox').value.toLowerCase();
            const items = document.querySelectorAll('.channel-item');
            
            if (!keyword) {
                // æ²¡æœ‰æœç´¢å…³é”®è¯ï¼Œæ˜¾ç¤ºå½“å‰åˆ†ç»„çš„æ‰€æœ‰é¢‘é“
                items.forEach(item => {
                    item.style.display = 'block';
                });
            } else {
                // æœ‰æœç´¢å…³é”®è¯ï¼Œç­›é€‰åŒ¹é…çš„é¢‘é“
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(keyword) ? 'block' : 'none';
                });
            }
        }

        function normalizeExternalConfig(payload) {
            const data = payload && payload.data !== undefined ? payload.data : payload || {};
            if (Array.isArray(data)) {
                return {
                    enabled: true,
                    includeInPlaylists: true,
                    updateOnStartup: true,
                    sources: data
                };
            }
            return {
                enabled: true, // é»˜è®¤å§‹ç»ˆå¯ç”¨è‡ªå®šä¹‰æº
                includeInPlaylists: data.includeInPlaylists !== false,
                updateOnStartup: data.updateOnStartup !== false,
                sources: Array.isArray(data.sources) ? data.sources : []
            };
        }

        function renderExternalSources() {
            const externalSourceList = document.getElementById('externalSourceList');
            const externalSourceCount = document.getElementById('externalSourceCount');
            const detail = document.getElementById('externalDetail');

            // æ·»åŠ DOMå…ƒç´ å®‰å…¨æ£€æŸ¥
            if (!externalSourceList || !externalSourceCount || !detail) {
                console.error('è‡ªå®šä¹‰æºç›¸å…³DOMå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            // æ¸²æŸ“ç”¨æˆ·æºåˆ—è¡¨
            if (!externalConfig.sources || externalConfig.sources.length === 0) {
                externalSourceCount.textContent = '0';
                externalSourceList.innerHTML = '<div class="empty-group" style="padding: 12px; color: #999; font-size: 13px;">æš‚æ— è‡ªå®šä¹‰æº<br>ç‚¹å‡»"æ·»åŠ æº"å¼€å§‹é…ç½®</div>';
                detail.innerHTML = '<div class="external-empty">è¯·åœ¨å·¦ä¾§é€‰æ‹©æˆ–æ·»åŠ æº</div>';
                selectedExternalIndex = null;
                return;
            }

            const enabledCount = externalConfig.sources.filter(s => s.enabled !== false).length;
            externalSourceCount.textContent = `${enabledCount}/${externalConfig.sources.length}`;
            
            externalSourceList.innerHTML = '';
            externalConfig.sources.forEach((source, index) => {
                const navItem = document.createElement('div');
                navItem.className = 'external-nav-item' + (selectedExternalIndex === index ? ' active' : '');
                
                const statusIcon = source.enabled !== false ? 'âœ“' : 'Ã—';
                const statusColor = source.enabled !== false ? '#52c41a' : '#999';
                
                // æ¨¡å¼æ ‡è¯†
                const modeText = source.mode === 'fetch' ? 'æŠ“å–' : 'ç›´è¿';
                const modeClass = source.mode === 'fetch' ? 'fetch' : 'direct';
                
                navItem.innerHTML = `
                    <div class="external-nav-title">${source.name || 'æœªå‘½åæº'}</div>
                    <div class="external-nav-meta">
                        <span>${source.group || 'æœªåˆ†ç»„'}</span>
                        <span class="external-mode-badge ${modeClass}">${modeText}</span>
                        <span style="color: ${statusColor};">${statusIcon}</span>
                    </div>
                `;
                navItem.onclick = () => selectExternalSource(index);
                externalSourceList.appendChild(navItem);
            });

            // æ¸²æŸ“å³ä¾§è¯¦æƒ…
            if (selectedExternalIndex !== null && externalConfig.sources[selectedExternalIndex]) {
                renderExternalDetail(selectedExternalIndex);
            } else if (externalConfig.sources.length > 0) {
                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
                selectExternalSource(0);
            }
        }

        // è·å–å’ªå’•æºçš„æ‰€æœ‰åˆ†ç»„
        function getMiguGroups() {
            const groups = new Set();
            groups.add('æœªåˆ†ç»„');
            
            if (allChannels && Array.isArray(allChannels)) {
                allChannels.forEach(category => {
                    if (category && category.name) {
                        groups.add(category.name);
                    }
                });
            }
            
            return Array.from(groups).sort((a, b) => {
                if (a === 'æœªåˆ†ç»„') return 1;
                if (b === 'æœªåˆ†ç»„') return -1;
                return a.localeCompare(b, 'zh-CN');
            });
        }
        
        function renderGroupSelect(index, currentGroup) {
            const groups = getMiguGroups();
            const options = groups.map(group => 
                `<option value="${group}" ${group === currentGroup ? 'selected' : ''}>${group}</option>`
            ).join('');
            return `<select onchange="updateExternalField(${index}, 'group', this.value)">${options}</select>`;
        }

        function selectExternalSource(index) {
            selectedExternalIndex = index;
            
            // æ›´æ–°å·¦ä¾§é«˜äº®ï¼ˆåªæ›´æ–°ç”¨æˆ·æºåˆ—è¡¨ï¼‰
            const externalSourceList = document.getElementById('externalSourceList');
            externalSourceList.querySelectorAll('.external-nav-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // æ¸²æŸ“å³ä¾§è¯¦æƒ…
            renderExternalDetail(index);
        }

        function renderExternalDetail(index) {
            const detail = document.getElementById('externalDetail');
            const source = externalConfig.sources[index];
            
            // æ·»åŠ DOMå…ƒç´ å®‰å…¨æ£€æŸ¥
            if (!detail) {
                console.error('externalDetail å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            if (!source) {
                detail.innerHTML = '<div class="external-empty">è¯·åœ¨å·¦ä¾§é€‰æ‹©æˆ–æ·»åŠ æº</div>';
                return;
            }
            
            const isEnabled = source.enabled !== false;
            const statusBadge = isEnabled 
                ? '<span class="status-badge enabled">âœ“ å·²å¯ç”¨</span>' 
                : '<span class="status-badge disabled">Ã— å·²ç¦ç”¨</span>';
            
            // æ™ºèƒ½åˆ¤æ–­æ¨¡å¼ï¼šå¦‚æœæ²¡æœ‰ mode å­—æ®µï¼Œæ ¹æ®æ˜¯å¦æœ‰ webUrl æ¥åˆ¤æ–­
            let mode = source.mode;
            if (!mode) {
                // å…¼å®¹æ—§æ•°æ®ï¼šæœ‰ webUrl ä¸”éç©ºåˆ™ä¸ºæŠ“å–æ¨¡å¼ï¼Œå¦åˆ™ä¸ºç›´è¿æ¨¡å¼
                mode = (source.webUrl && source.webUrl.trim()) ? 'fetch' : 'direct';
                // è‡ªåŠ¨è®¾ç½® mode å­—æ®µï¼Œé¿å…ä¸‹æ¬¡å†åˆ¤æ–­
                source.mode = mode;
            }
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºå·²ä¿å­˜çš„æºï¼ˆæœ‰lastUpdatedæˆ–m3u8Urlä¸ä¸ºç©ºï¼‰
            const isSaved = source.lastUpdated || (source.m3u8Url && source.m3u8Url.trim());
            
            // æ¨¡å¼åˆ‡æ¢å™¨ï¼ˆåªåœ¨æœªä¿å­˜æ—¶æ˜¾ç¤ºï¼‰
            const modeSwitcher = isSaved ? '' : `
                <div class="mode-switcher">
                    <button class="mode-switch-btn ${mode === 'direct' ? 'active' : ''}" onclick="switchSourceMode(${index}, 'direct')">
                        ç›´è¿æ¨¡å¼
                    </button>
                    <button class="mode-switch-btn ${mode === 'fetch' ? 'active' : ''}" onclick="switchSourceMode(${index}, 'fetch')">
                        æŠ“å–æ¨¡å¼
                    </button>
                </div>
            `;
            
            // æ ¹æ®æ¨¡å¼æ¸²æŸ“ä¸åŒçš„è¡¨å•
            if (mode === 'fetch') {
                // æŠ“å–æ¨¡å¼ï¼šç½‘é¡µåœ°å€ -> è‡ªåŠ¨æŠ“å–m3u8
                detail.innerHTML = `
                    <div class="external-detail-header">
                        <div class="external-detail-title">${source.name || 'æœªå‘½åæº'}</div>
                        ${statusBadge}
                    </div>
                    ${modeSwitcher}
                    <div class="external-detail-body">
                        <div class="external-field-row">
                            <div class="external-field">
                                <label>é¢‘é“åç§° *</label>
                                <input type="text" value="${source.name || ''}" oninput="updateExternalField(${index}, 'name', this.value)" placeholder="ä¾‹ï¼šä½“è‚²é¢‘é“">
                            </div>
                            <div class="external-field">
                                <label>æ‰€å±åˆ†ç»„ *</label>
                                ${renderGroupSelect(index, source.group || 'æœªåˆ†ç»„')}
                            </div>
                        </div>
                        <div class="external-field">
                            <label>æ’­æ”¾é¡µé¢åœ°å€ *</label>
                            <input type="text" value="${source.webUrl || ''}" oninput="updateExternalField(${index}, 'webUrl', this.value)" placeholder="ä¾‹ï¼šhttps://example.com/live.html">
                            <div class="form-hint">å¡«å†™ç›´æ’­é¡µé¢åœ°å€ï¼Œç‚¹å‡»"æŠ“å–å¹¶ä¿å­˜"åç³»ç»Ÿä¼šè‡ªåŠ¨æå–m3u8é“¾æ¥</div>
                        </div>
                        <div class="external-field">
                            <label>è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" min="60" step="60" value="${source.refreshInterval || 240}" oninput="updateExternalField(${index}, 'refreshInterval', parseInt(this.value) || 240)" placeholder="240">
                            <div class="form-hint">æ¯éš”å¤šå°‘åˆ†é’Ÿè‡ªåŠ¨é‡æ–°æŠ“å–m3u8é“¾æ¥ï¼Œé»˜è®¤240åˆ†é’Ÿï¼ˆ4å°æ—¶ï¼‰ï¼Œæ­¥å¹…1å°æ—¶</div>
                        </div>
                    </div>
                    <div class="external-detail-footer">
                        <div class="external-switches">
                            <label>
                                <input type="checkbox" ${source.enabled !== false ? 'checked' : ''} onchange="updateExternalField(${index}, 'enabled', this.checked)">
                                å¯ç”¨æ­¤æº
                            </label>
                            <label>
                                <input type="checkbox" ${source.autoRefresh !== false ? 'checked' : ''} onchange="updateExternalField(${index}, 'autoRefresh', this.checked)">
                                è‡ªåŠ¨åˆ·æ–°
                            </label>
                            <label>
                                <input type="checkbox" ${source.updateOnStartup !== false ? 'checked' : ''} onchange="updateExternalField(${index}, 'updateOnStartup', this.checked)">
                                é‡å¯æ—¶æ›´æ–°
                            </label>
                        </div>
                        <div class="external-actions">
                            <button class="btn btn-small btn-primary" onclick="fetchAndSaveSource(${index})" ${updatingSourceIndex === index ? 'disabled' : ''}>
                                ${updatingSourceIndex === index ? 'ğŸ”„ æŠ“å–ä¸­...' : 'ğŸ” æŠ“å–å¹¶ä¿å­˜'}
                            </button>
                            <button class="btn btn-small btn-danger" onclick="removeExternalSource(${index})" ${updatingSourceIndex === index ? 'disabled' : ''}>ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                `;
            } else {
                // ç›´è¿æ¨¡å¼ï¼šç›´æ¥å¡«å†™m3u8é“¾æ¥
                detail.innerHTML = `
                    <div class="external-detail-header">
                        <div class="external-detail-title">${source.name || 'æœªå‘½åæº'}</div>
                        ${statusBadge}
                    </div>
                    ${modeSwitcher}
                    <div class="external-detail-body">
                        <div class="external-field-row">
                            <div class="external-field">
                                <label>é¢‘é“åç§° *</label>
                                <input type="text" value="${source.name || ''}" oninput="updateExternalField(${index}, 'name', this.value)" placeholder="ä¾‹ï¼šä½“è‚²é¢‘é“">
                            </div>
                            <div class="external-field">
                                <label>æ‰€å±åˆ†ç»„ *</label>
                                ${renderGroupSelect(index, source.group || 'æœªåˆ†ç»„')}
                            </div>
                        </div>
                        <div class="external-field">
                            <label>m3u8 ç›´æ’­é“¾æ¥ *</label>
                            <input type="text" value="${source.m3u8Url || ''}" oninput="updateExternalField(${index}, 'm3u8Url', this.value)" placeholder="ä¾‹ï¼šhttps://example.com/live.m3u8">
                            <div class="form-hint">ç›´æ¥å¡«å†™m3u8ç›´æ’­æµåœ°å€</div>
                        </div>
                    </div>
                    <div class="external-detail-footer">
                        <div class="external-switches">
                            <label>
                                <input type="checkbox" ${source.enabled !== false ? 'checked' : ''} onchange="updateExternalField(${index}, 'enabled', this.checked)">
                                å¯ç”¨æ­¤æº
                            </label>
                        </div>
                        <div class="external-actions">
                            <button class="btn btn-small btn-success" onclick="saveDirectSource(${index})">
                                ğŸ’¾ ä¿å­˜
                            </button>
                            <button class="btn btn-small btn-danger" onclick="removeExternalSource(${index})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }
        }

        function addExternalSource() {
            // é»˜è®¤æ·»åŠ ç›´è¿æ¨¡å¼
            const newSource = {
                name: '',
                group: 'æœªåˆ†ç»„',
                enabled: true,
                mode: 'direct', // é»˜è®¤ç›´è¿æ¨¡å¼
                m3u8Url: '',
                webUrl: ''
            };
            
            // æ’å…¥åˆ°æ•°ç»„å¼€å¤´ï¼Œè®©æ–°å¢çš„æºæ˜¾ç¤ºåœ¨æœ€ä¸Šé¢
            externalConfig.sources.unshift(newSource);
            selectedExternalIndex = 0;
            renderExternalSources();
        }

        function switchSourceMode(index, newMode) {
            const source = externalConfig.sources[index];
            if (!source) return;
            
            // åˆ‡æ¢æ¨¡å¼
            source.mode = newMode;
            
            // æ ¹æ®æ–°æ¨¡å¼æ¸…ç©ºå¯¹åº”çš„URLå­—æ®µ
            if (newMode === 'fetch') {
                // åˆ‡æ¢åˆ°æŠ“å–æ¨¡å¼ï¼Œæ¸…ç©ºm3u8Url
                source.m3u8Url = '';
                // æ·»åŠ å¿…è¦çš„é…ç½®
                if (!source.autoRefresh) source.autoRefresh = true;
                if (!source.refreshInterval) source.refreshInterval = 60;
                if (!source.updateOnStartup) source.updateOnStartup = true;
                if (!source.extractOptions) {
                    source.extractOptions = {
                        waitTime: 5000,
                        headless: true
                    };
                }
            } else if (newMode === 'direct') {
                // åˆ‡æ¢åˆ°ç›´è¿æ¨¡å¼ï¼Œæ¸…ç©ºwebUrl
                source.webUrl = '';
            }
            
            // é‡æ–°æ¸²æŸ“è¯¦æƒ…é¢æ¿
            renderExternalDetail(index);
        }

        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        let confirmCallback = null;

        function showConfirm(message, title = 'localhost:1905 æ˜¾ç¤º') {
            return new Promise((resolve) => {
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmOverlay').classList.add('show');
                confirmCallback = resolve;
            });
        }

        function hideConfirm(result) {
            document.getElementById('confirmOverlay').classList.remove('show');
            if (confirmCallback) {
                confirmCallback(result);
                confirmCallback = null;
            }
        }

        async function removeExternalSource(index) {
            const confirmed = await showConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤–éƒ¨æºå—ï¼Ÿ');
            if (!confirmed) {
                return;
            }
            
            const sourceName = externalConfig.sources[index]?.name || 'æœªå‘½åæº';
            
            try {
                showStatus('æ­£åœ¨åˆ é™¤...', 'info');
                
                // ä»é…ç½®ä¸­åˆ é™¤
                externalConfig.sources.splice(index, 1);
                
                // è°ƒç”¨ä¿å­˜APIï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨é‡æ–°ç”Ÿæˆæ’­æ”¾åˆ—è¡¨
                const response = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'save', sources: externalConfig })
                });

                const result = await response.json();
                
                if (response.ok && result.success !== false) {
                    showStatus(`${sourceName} åˆ é™¤æˆåŠŸå¹¶å·²ä»é¢‘é“åˆ—è¡¨ä¸­ç§»é™¤`, 'success');
                    
                    // è°ƒæ•´é€‰ä¸­ç´¢å¼•
                    if (selectedExternalIndex === index) {
                        selectedExternalIndex = externalConfig.sources.length > 0 ? 0 : null;
                    } else if (selectedExternalIndex > index) {
                        selectedExternalIndex--;
                    }
                    
                    renderExternalSources();
                    
                    // é‡æ–°åŠ è½½æ‰€æœ‰é¢‘é“æ•°æ®ä»¥åˆ·æ–°æ˜¾ç¤º
                    const channelsRes = await fetch('/api/channels');
                    if (channelsRes.ok) {
                        allChannels = await channelsRes.json();
                        renderChannels();
                    }
                } else {
                    // åˆ é™¤å¤±è´¥ï¼Œæ¢å¤æ•°æ®ï¼ˆéœ€è¦é‡æ–°åŠ è½½é…ç½®ï¼‰
                    showStatus(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                    const externalRes = await fetch('/api/external-sources');
                    const externalPayload = await externalRes.json();
                    externalConfig = normalizeExternalConfig(externalPayload);
                    renderExternalSources();
                }
            } catch (error) {
                showStatus('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                // æ¢å¤æ•°æ®
                const externalRes = await fetch('/api/external-sources');
                const externalPayload = await externalRes.json();
                externalConfig = normalizeExternalConfig(externalPayload);
                renderExternalSources();
            }
        }

        function updateExternalField(index, field, value) {
            externalConfig.sources[index][field] = value;
            
            // åªæ›´æ–°å·¦ä¾§åˆ—è¡¨çš„å¯¹åº”é¡¹ï¼Œé¿å…é‡æ–°æ¸²æŸ“æ•´ä¸ªè¡¨å•å¯¼è‡´è¾“å…¥æ¡†å¤±ç„¦
            if (field === 'name') {
                // æ›´æ–°å·¦ä¾§å¯¼èˆªé¡¹çš„æ ‡é¢˜å’Œå¤´éƒ¨æ ‡é¢˜
                const navItems = document.querySelectorAll('.external-nav-item');
                if (navItems[index]) {
                    const titleEl = navItems[index].querySelector('.external-nav-title');
                    if (titleEl) {
                        titleEl.textContent = value || 'æœªå‘½åæº';
                    }
                }
                // æ›´æ–°è¯¦æƒ…é¢æ¿çš„æ ‡é¢˜
                const detailTitle = document.querySelector('.external-detail-title');
                if (detailTitle) {
                    detailTitle.textContent = value || 'æœªå‘½åæº';
                }
            } else if (field === 'enabled') {
                // åªæœ‰ enabled å­—æ®µå˜åŒ–æ—¶æ‰é‡æ–°æ¸²æŸ“ï¼Œå› ä¸ºéœ€è¦æ›´æ–°å›¾æ ‡å’Œå¾½ç« 
                renderExternalSources();
            }
        }

        async function updateExternalSource(index) {
            if (updatingSourceIndex !== null) {
                showStatus('è¯·ç­‰å¾…å½“å‰æŠ“å–å®Œæˆ', 'error');
                return;
            }
            
            const sourceName = externalConfig.sources[index].name || 'å¤–éƒ¨æº';
            updatingSourceIndex = index;
            renderExternalSources(); // åˆ·æ–°UIæ˜¾ç¤ºloadingçŠ¶æ€
            
            try {
                // å…ˆä¿å­˜é…ç½®ï¼Œç¡®ä¿åç«¯ç´¢å¼•åŒæ­¥
                showStatus(`æ­£åœ¨ä¿å­˜é…ç½®...`, 'info');
                const saveResponse = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'save', sources: externalConfig })
                });
                
                if (!saveResponse.ok) {
                    showStatus('é…ç½®ä¿å­˜å¤±è´¥ï¼Œæ— æ³•æ›´æ–°', 'error');
                    return;
                }
                
                // ä¿å­˜æˆåŠŸåæ‰§è¡Œæ›´æ–°
                showStatus(`æ­£åœ¨æå– ${sourceName} çš„ m3u8 é“¾æ¥...`, 'info');
                
                const response = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'update', index })
                });

                const result = await response.json();
                
                // é‡æ–°åŠ è½½é…ç½®ç¡®ä¿UIåŒæ­¥ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥éƒ½åŠ è½½ï¼‰
                const externalRes = await fetch('/api/external-sources');
                const externalPayload = await externalRes.json();
                externalConfig = normalizeExternalConfig(externalPayload);
                
                // æ ¹æ® result.success åˆ¤æ–­è€Œä¸æ˜¯ response.ok
                if (result.success !== false) {
                    const message = result.warning 
                        ? `${sourceName} æ›´æ–°æˆåŠŸï¼ˆ${result.warning}ï¼‰` 
                        : `${sourceName} æ›´æ–°æˆåŠŸï¼m3u8 é“¾æ¥å·²è‡ªåŠ¨å¡«å……`;
                    showStatus(message, 'success');
                    
                    // é‡æ–°åŠ è½½æ‰€æœ‰é¢‘é“æ•°æ®ä»¥åˆ·æ–°æ˜¾ç¤º
                    const channelsRes = await fetch('/api/channels');
                    if (channelsRes.ok) {
                        allChannels = await channelsRes.json();
                        renderChannels();
                    }
                } else {
                    showStatus(`${sourceName} æ›´æ–°å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showStatus(`${sourceName} æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            } finally {
                updatingSourceIndex = null;
                renderExternalSources(); // æ¸…é™¤loadingçŠ¶æ€å¹¶åˆ·æ–°UI
            }
        }

        // æŠ“å–æ¨¡å¼ï¼šæŠ“å–å¹¶ä¿å­˜
        async function fetchAndSaveSource(index) {
            if (updatingSourceIndex !== null) {
                showStatus('è¯·ç­‰å¾…å½“å‰æŠ“å–å®Œæˆ', 'error');
                return;
            }
            
            const source = externalConfig.sources[index];
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!source.name || !source.name.trim()) {
                showStatus('è¯·å¡«å†™é¢‘é“åç§°', 'error');
                return;
            }
            if (!source.group || !source.group.trim()) {
                showStatus('è¯·å¡«å†™æ‰€å±åˆ†ç»„', 'error');
                return;
            }
            if (!source.webUrl || !source.webUrl.trim()) {
                showStatus('è¯·å¡«å†™æ’­æ”¾é¡µé¢åœ°å€', 'error');
                return;
            }
            
            const sourceName = source.name;
            updatingSourceIndex = index;
            renderExternalSources(); // åˆ·æ–°UIæ˜¾ç¤ºloadingçŠ¶æ€
            
            try {
                // å…ˆä¿å­˜é…ç½®
                showStatus(`æ­£åœ¨ä¿å­˜é…ç½®...`, 'info');
                const saveResponse = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'save', sources: externalConfig })
                });
                
                if (!saveResponse.ok) {
                    showStatus('é…ç½®ä¿å­˜å¤±è´¥ï¼Œæ— æ³•æŠ“å–', 'error');
                    return;
                }
                
                // æ‰§è¡ŒæŠ“å–
                showStatus(`æ­£åœ¨æŠ“å– ${sourceName} çš„ m3u8 é“¾æ¥...`, 'info');
                
                const response = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'update', index })
                });

                const result = await response.json();
                
                // é‡æ–°åŠ è½½é…ç½®ç¡®ä¿UIåŒæ­¥
                const externalRes = await fetch('/api/external-sources');
                const externalPayload = await externalRes.json();
                externalConfig = normalizeExternalConfig(externalPayload);
                
                // åˆ¤æ–­æŠ“å–ç»“æœ
                if (result.success !== false) {
                    const message = result.warning 
                        ? `${sourceName} æŠ“å–æˆåŠŸï¼ˆ${result.warning}ï¼‰å¹¶å·²åŒæ­¥åˆ°é¢‘é“åˆ—è¡¨` 
                        : `${sourceName} æŠ“å–æˆåŠŸï¼å·²åŒæ­¥åˆ°é¢‘é“åˆ—è¡¨`;
                    showStatus(message, 'success');
                    
                    // é‡æ–°åŠ è½½æ‰€æœ‰é¢‘é“æ•°æ®ä»¥åˆ·æ–°æ˜¾ç¤º
                    const channelsRes = await fetch('/api/channels');
                    if (channelsRes.ok) {
                        allChannels = await channelsRes.json();
                        renderChannels();
                    }
                } else {
                    showStatus(`${sourceName} æŠ“å–å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showStatus(`${sourceName} æŠ“å–å¤±è´¥: ${error.message}`, 'error');
            } finally {
                updatingSourceIndex = null;
                renderExternalSources(); // æ¸…é™¤loadingçŠ¶æ€å¹¶åˆ·æ–°UI
            }
        }

        // ç›´è¿æ¨¡å¼ï¼šç›´æ¥ä¿å­˜
        async function saveDirectSource(index) {
            const source = externalConfig.sources[index];
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!source.name || !source.name.trim()) {
                showStatus('è¯·å¡«å†™é¢‘é“åç§°', 'error');
                return;
            }
            if (!source.group || !source.group.trim()) {
                showStatus('è¯·å¡«å†™æ‰€å±åˆ†ç»„', 'error');
                return;
            }
            if (!source.m3u8Url || !source.m3u8Url.trim()) {
                showStatus('è¯·å¡«å†™m3u8ç›´æ’­é“¾æ¥', 'error');
                return;
            }
            
            try {
                showStatus('æ­£åœ¨ä¿å­˜...', 'info');
                
                const response = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'save', sources: externalConfig })
                });

                const result = await response.json();
                if (response.ok && result.success !== false) {
                    showStatus(`${source.name} ä¿å­˜æˆåŠŸå¹¶å·²åŒæ­¥åˆ°é¢‘é“åˆ—è¡¨`, 'success');
                    renderExternalSources(); // ä¿å­˜æˆåŠŸååˆ·æ–°UI
                    
                    // é‡æ–°åŠ è½½æ‰€æœ‰é¢‘é“æ•°æ®ä»¥åˆ·æ–°æ˜¾ç¤º
                    const channelsRes = await fetch('/api/channels');
                    if (channelsRes.ok) {
                        allChannels = await channelsRes.json();
                        renderChannels();
                    }
                } else {
                    showStatus(result.message || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯ï¼ˆToast é€šçŸ¥ï¼‰
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            
            // è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                status.classList.add('show');
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        // æ¸²æŸ“ç³»ç»Ÿé…ç½®
        function renderSystemConfig() {
            document.getElementById('sysUserId').value = systemConfig.userId || '';
            document.getElementById('sysToken').value = systemConfig.token || '';
            document.getElementById('sysPort').value = systemConfig.port || 1905;
            document.getElementById('sysHost').value = systemConfig.host || '';
            document.getElementById('sysRateType').value = systemConfig.rateType || 3;
            document.getElementById('sysPass').value = systemConfig.pass || '';
            document.getElementById('sysProgramInterval').value = systemConfig.programInfoUpdateInterval || '8';
            document.getElementById('sysEnableHDR').checked = systemConfig.enableHDR !== false;
            document.getElementById('sysEnableH265').checked = systemConfig.enableH265 !== false;
        }

        // åˆå§‹åŒ–å’ªå’•è´¦å·è·å–Bookmarklet
        function initMiguBookmarklet() {
            const bookmarkletCode = `javascript:(function(){
try{
const userInfo=document.cookie.split('; ').find(c=>c.startsWith('UserInfo='))?.split('=')[1];
if(!userInfo){
    alert('âŒ æœªæ‰¾åˆ°å’ªå’•è´¦å·ä¿¡æ¯\\n\\nè¯·ç¡®ä¿ï¼š\\n1. å·²ç™»å½•å’ªå’•è§†é¢‘ç½‘ç«™\\n2. åœ¨å’ªå’•è§†é¢‘é¡µé¢ç‚¹å‡»æ­¤ä¹¦ç­¾');
    return;
}
const[userId,token]=userInfo.split('|');
if(!userId||!token){
    alert('âŒ è´¦å·ä¿¡æ¯æ ¼å¼é”™è¯¯');
    return;
}

const copyText='ç”¨æˆ·ID: '+userId+'\\nToken: '+token;
const textarea=document.createElement('textarea');
textarea.value=copyText;
textarea.style.position='fixed';
textarea.style.opacity='0';
document.body.appendChild(textarea);
textarea.select();
const success=document.execCommand('copy');
document.body.removeChild(textarea);

if(success){
    alert('âœ… å’ªå’•è´¦å·ä¿¡æ¯å·²å¤åˆ¶æˆåŠŸï¼\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\nç”¨æˆ·ID: '+userId+'\\nToken: '+token+'\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\nè¯·ç²˜è´´åˆ°ç®¡ç†åå°ã€ç³»ç»Ÿè®¾ç½®ã€‘');
}else{
    prompt('âš ï¸ è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ç”¨æˆ·IDï¼š',userId);
    prompt('è¯·æ‰‹åŠ¨å¤åˆ¶Tokenï¼š',token);
}
}catch(e){
    alert('âŒ è·å–å¤±è´¥ï¼š'+e.message);
}
})();`;
            
            const bookmarklet = document.getElementById('miguBookmarklet');
            bookmarklet.href = bookmarkletCode;
            
            // ä¿å­˜bookmarkletä»£ç åˆ°å…¨å±€å˜é‡ï¼Œä¾›å¤åˆ¶åŠŸèƒ½ä½¿ç”¨
            window.bookmarkletCode = bookmarkletCode;
            
            // ç‚¹å‡»æ˜¾ç¤ºå¼•å¯¼å¼¹çª—
            bookmarklet.addEventListener('click', (e) => {
                e.preventDefault();
                openBookmarkletGuide();
            });
            
            // æ‹–æ‹½äº‹ä»¶
            bookmarklet.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('text/plain', bookmarkletCode);
            });
        }
        
        // æ‰“å¼€Bookmarkletå¼•å¯¼å¼¹çª—
        function openBookmarkletGuide() {
            document.getElementById('bookmarkletGuideModal').style.display = 'block';
        }
        
        // å…³é—­Bookmarkletå¼•å¯¼å¼¹çª—
        function closeBookmarkletGuide() {
            document.getElementById('bookmarkletGuideModal').style.display = 'none';
        }
        
        // å¤åˆ¶Bookmarkletä»£ç 
        function copyBookmarkletCode() {
            const code = window.bookmarkletCode;
            if (!code) {
                showStatus('ä»£ç æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                const success = document.execCommand('copy');
                if (success) {
                    showStatus('âœ… Bookmarklet ä»£ç å·²å¤åˆ¶ï¼è¯·åœ¨ä¹¦ç­¾ç®¡ç†å™¨ä¸­ç²˜è´´', 'success');
                } else {
                    showStatus('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶', 'error');
                }
            } catch (e) {
                showStatus('å¤åˆ¶å¤±è´¥: ' + e.message, 'error');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        // ä¿å­˜ç³»ç»Ÿé…ç½®
        async function saveSystemConfig() {
            try {
                const port = parseInt(document.getElementById('sysPort').value) || 1905;
                let host = document.getElementById('sysHost').value.trim();
                
                // æ™ºèƒ½å¤„ç†å…¬ç½‘åœ°å€ï¼šå¦‚æœæ²¡æœ‰æŒ‡å®šç«¯å£ï¼Œè‡ªåŠ¨æ·»åŠ æœåŠ¡ç«¯å£
                if (host && !host.match(/:\d+$/)) {
                    host = `${host}:${port}`;
                }
                
                const config = {
                    userId: document.getElementById('sysUserId').value,
                    token: document.getElementById('sysToken').value,
                    port: port,
                    host: host,
                    rateType: parseInt(document.getElementById('sysRateType').value) || 3,
                    pass: document.getElementById('sysPass').value,
                    programInfoUpdateInterval: document.getElementById('sysProgramInterval').value || '8',
                    enableHDR: document.getElementById('sysEnableHDR').checked,
                    enableH265: document.getElementById('sysEnableH265').checked
                };

                const response = await fetch('/api/system-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(result.message, 'success');
                } else {
                    showStatus(result.message || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é‡å¯æœåŠ¡
        async function restartService() {
            const confirmed = await showConfirm(
                'ç¡®å®šè¦é‡å¯æœåŠ¡å—ï¼Ÿ\n\næ³¨æ„ï¼š\n1. é‡å¯æœŸé—´æœåŠ¡å°†æš‚æ—¶ä¸å¯ç”¨ï¼ˆçº¦5-10ç§’ï¼‰\n2. è¯·ç¡®ä¿å·²ä¿å­˜æ‰€æœ‰é…ç½®\n3. Docker/PM2 ä¼šè‡ªåŠ¨é‡å¯ï¼Œç›´æ¥è¿è¡Œ node éœ€è¦æ‰‹åŠ¨é‡å¯',
                'é‡å¯æœåŠ¡'
            );
            if (!confirmed) {
                return;
            }

            try {
                showStatus('æ­£åœ¨é‡å¯æœåŠ¡ï¼Œè¯·ç¨å€™...', 'success');

                const response = await fetch('/api/restart', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('æœåŠ¡é‡å¯ä¸­...è¯·ç­‰å¾…çº¦ 5-10 ç§’ååˆ·æ–°é¡µé¢', 'success');
                    
                    // 15ç§’åè‡ªåŠ¨åˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        location.reload();
                    }, 15000);
                } else {
                    showStatus(result.message || 'é‡å¯å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('é‡å¯è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ========== æˆ‘çš„é¢‘é“ç®¡ç† ==========
        let myPlaylistData = [];
        let myPlaylistOriginalData = []; // åŸå§‹å®Œæ•´æ•°æ®ï¼ˆç”¨äºæ˜¾ç¤ºè¢«åˆ é™¤çš„é¢‘é“ï¼‰
        let myPlaylistConfig = {
            channelGroupMap: {},
            hiddenChannels: [],
            customGroups: [],
            groupOrder: [],
            deletedGroups: []
        };
        let selectedGroupIndex = 0; // å½“å‰é€‰ä¸­çš„åˆ†ç»„ç´¢å¼•
        let isViewingDeleted = false; // æ˜¯å¦æ­£åœ¨æŸ¥çœ‹è¢«åˆ é™¤åŒºåŸŸ
        let isBatchMode = false; // æ˜¯å¦å¤„äºæ‰¹é‡ç®¡ç†æ¨¡å¼
        let selectedChannels = new Set(); // æ‰¹é‡é€‰ä¸­çš„é¢‘é“ID

        async function loadMyPlaylist(resetView = true) {
            try {
                const response = await fetch('/api/my-playlist');
                const result = await response.json();
                console.log('æˆ‘çš„æ’­æ”¾åˆ—è¡¨APIè¿”å›:', result);
                
                if (result.success) {
                    myPlaylistData = result.data;
                    
                    // ä½¿ç”¨APIè¿”å›çš„åŸå§‹æ•°æ®
                    if (result.originalData && result.originalData.length > 0) {
                        myPlaylistOriginalData = result.originalData;
                        console.log('ä½¿ç”¨APIè¿”å›çš„åŸå§‹æ•°æ®:', myPlaylistOriginalData.length, 'groups');
                    } else {
                        console.warn('APIæœªè¿”å›åŸå§‹æ•°æ®ï¼Œä½¿ç”¨å½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½');
                        myPlaylistOriginalData = JSON.parse(JSON.stringify(myPlaylistData));
                    }
                    
                    // åªåœ¨éœ€è¦æ—¶é‡ç½®è§†å›¾çŠ¶æ€
                    if (resetView) {
                        selectedGroupIndex = 0;
                        isViewingDeleted = false;
                    }
                    
                    renderMyPlaylist();
                }
            } catch (error) {
                console.error('åŠ è½½æˆ‘çš„é¢‘é“å¤±è´¥:', error);
                showStatus('åŠ è½½æˆ‘çš„é¢‘é“å¤±è´¥', 'error');
            }
        }

        async function loadMyPlaylistConfig() {
            try {
                const response = await fetch('/api/my-playlist-config');
                const result = await response.json();
                
                if (result.success) {
                    myPlaylistConfig = result.data;
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        function renderMyPlaylist() {
            renderGroupLists();
            renderGroupDetail();
        }

        function renderGroupLists() {
            // æ¸²æŸ“æ´»è·ƒåˆ†ç»„åˆ—è¡¨
            const activeList = document.getElementById('activeGroupList');
            if (!activeList) return;

            if (myPlaylistData.length === 0) {
                activeList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">æš‚æ— é¢‘é“</div>';
            } else {
                // è¿‡æ»¤å‡ºéç©ºåˆ†ç»„ï¼Œå¹¶ä¿ç•™åŸå§‹ç´¢å¼•
                const nonEmptyGroups = myPlaylistData
                    .map((group, originalIndex) => ({ group, originalIndex }))
                    .filter(item => item.group.channels.length > 0);

                if (nonEmptyGroups.length === 0) {
                    activeList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">æ— é¢‘é“</div>';
                } else {
                    activeList.innerHTML = nonEmptyGroups.map(item => `
                        <div class="my-playlist-group-item ${!isViewingDeleted && selectedGroupIndex === item.originalIndex ? 'active' : ''}" 
                             onclick="selectGroup(${item.originalIndex}, false)">
                            <span>${item.group.name}</span>
                            <span style="color: #999; font-size: 12px;">${item.group.channels.length}</span>
                        </div>
                    `).join('');
                }
            }

            // æ¸²æŸ“è¢«åˆ é™¤åˆ†ç»„åˆ—è¡¨
            const deletedList = document.getElementById('deletedGroupList');
            if (!deletedList) return;

            console.log('myPlaylistOriginalData:', myPlaylistOriginalData.length, 'groups');
            console.log('deletedGroups:', myPlaylistConfig.deletedGroups);
            console.log('hiddenChannels:', myPlaylistConfig.hiddenChannels);

            // ä»åŸå§‹æ•°æ®ä¸­æ‰¾å‡ºè¢«åˆ é™¤çš„åˆ†ç»„
            const deletedGroups = myPlaylistOriginalData.filter(group => 
                myPlaylistConfig.deletedGroups.includes(group.name)
            );

            console.log('æ‰¾åˆ°è¢«åˆ é™¤çš„åˆ†ç»„:', deletedGroups.length);

            // ä»åŸå§‹æ•°æ®ä¸­æ‰¾å‡ºè¢«éšè—çš„é¢‘é“ï¼ˆæŒ‰åŸå§‹åˆ†ç»„æ˜¾ç¤ºï¼‰
            const groupsWithHiddenChannels = myPlaylistOriginalData.map(group => {
                const hiddenChannels = group.channels.filter(ch => 
                    myPlaylistConfig.hiddenChannels.includes(ch.id) &&
                    !myPlaylistConfig.deletedGroups.includes(group.name)
                );
                if (hiddenChannels.length > 0) {
                    console.log(`åˆ†ç»„ "${group.name}" æœ‰ ${hiddenChannels.length} ä¸ªéšè—é¢‘é“:`, hiddenChannels.map(ch => ch.name));
                }
                return hiddenChannels.length > 0 ? {
                    ...group,
                    channels: hiddenChannels,
                    isPartialDelete: true
                } : null;
            }).filter(g => g !== null);

            console.log('æ‰¾åˆ°åŒ…å«éšè—é¢‘é“çš„åˆ†ç»„:', groupsWithHiddenChannels.length);

            const allDeletedGroups = [...deletedGroups, ...groupsWithHiddenChannels];

            // å¦‚æœæ­£åœ¨æŸ¥çœ‹å·²éšè—åŒºåŸŸï¼Œè°ƒæ•´selectedGroupIndexåˆ°æœ‰æ•ˆèŒƒå›´
            if (isViewingDeleted && allDeletedGroups.length > 0) {
                if (selectedGroupIndex >= allDeletedGroups.length) {
                    selectedGroupIndex = allDeletedGroups.length - 1;
                }
            }

            if (allDeletedGroups.length === 0) {
                deletedList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">æ— éšè—å†…å®¹</div>';
            } else {
                deletedList.innerHTML = allDeletedGroups.map((group, index) => `
                    <div class="my-playlist-group-item deleted ${isViewingDeleted && selectedGroupIndex === index ? 'active' : ''}" 
                         onclick="selectGroup(${index}, true)">
                        <span>${group.name}${group.isPartialDelete ? ' (éšè—é¢‘é“)' : ''}</span>
                        <span style="color: #999; font-size: 12px;">${group.channels.length}</span>
                    </div>
                `).join('');
            }
        }

        function selectGroup(index, isDeleted) {
            selectedGroupIndex = index;
            isViewingDeleted = isDeleted;
            renderGroupLists();
            renderGroupDetail();
        }

        function renderGroupDetail() {
            const container = document.getElementById('myPlaylistGroups');
            const header = document.getElementById('detailHeader');
            const title = document.getElementById('detailTitle');
            const actions = document.getElementById('detailActions');
            
            if (!container || !header || !title || !actions) return;

            let group, groupIndex;

            if (isViewingDeleted) {
                // æ˜¾ç¤ºè¢«åˆ é™¤çš„åˆ†ç»„
                const deletedGroups = myPlaylistOriginalData.filter(g => 
                    myPlaylistConfig.deletedGroups.includes(g.name)
                );
                const groupsWithHiddenChannels = myPlaylistOriginalData.map(g => {
                    const hiddenChannels = g.channels.filter(ch => 
                        myPlaylistConfig.hiddenChannels.includes(ch.id) &&
                        !myPlaylistConfig.deletedGroups.includes(g.name)
                    );
                    return hiddenChannels.length > 0 ? {
                        ...g,
                        channels: hiddenChannels,
                        isPartialDelete: true
                    } : null;
                }).filter(g => g !== null);

                const allDeletedGroups = [...deletedGroups, ...groupsWithHiddenChannels];
                
                // è°ƒæ•´selectedGroupIndexåˆ°æœ‰æ•ˆèŒƒå›´
                if (allDeletedGroups.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æ— éšè—å†…å®¹</div>';
                    header.style.display = 'none';
                    return;
                }
                
                if (selectedGroupIndex >= allDeletedGroups.length) {
                    selectedGroupIndex = allDeletedGroups.length - 1;
                }

                group = allDeletedGroups[selectedGroupIndex];
                header.style.display = 'flex';
                title.textContent = `${group.name} (${group.channels.length}ä¸ªé¢‘é“) - å·²éšè—`;
                
                // æ ¹æ®æ‰¹é‡æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„æ“ä½œæŒ‰é’®
                if (isBatchMode && group.isPartialDelete) {
                    // æ‰¹é‡æ¨¡å¼ï¼Œä»…å¯¹åŒ…å«éšè—é¢‘é“çš„åˆ†ç»„æ˜¾ç¤º
                    const selectedCount = selectedChannels.size;
                    actions.innerHTML = `
                        <button class="btn btn-sm" onclick="selectAllChannels()">å…¨é€‰</button>
                        <button class="btn btn-sm" onclick="deselectAllChannels()">å–æ¶ˆå…¨é€‰</button>
                        <button class="btn btn-success btn-sm" onclick="restoreSelectedChannels()" ${selectedCount === 0 ? 'disabled' : ''}>æ¢å¤é€‰ä¸­ (${selectedCount})</button>
                        <button class="btn btn-primary btn-sm" onclick="toggleBatchMode()">é€€å‡ºæ‰¹é‡</button>
                    `;
                } else if (group.isPartialDelete) {
                    // éæ‰¹é‡æ¨¡å¼ï¼ŒåŒ…å«éšè—é¢‘é“çš„åˆ†ç»„
                    actions.innerHTML = `
                        <button class="btn btn-sm" onclick="toggleBatchMode()">æ‰¹é‡ç®¡ç†</button>
                        <button class="btn btn-primary btn-sm" onclick="restoreAllChannelsInGroup()">æ¢å¤æ‰€æœ‰é¢‘é“</button>
                    `;
                } else {
                    // è¢«éšè—çš„å®Œæ•´åˆ†ç»„
                    actions.innerHTML = '<button class="btn btn-primary btn-sm" onclick="restoreGroup()">æ¢å¤åˆ†ç»„</button>';
                }

                // å¯¹äºè¢«éšè—çš„å®Œæ•´åˆ†ç»„ï¼Œä¸æ˜¾ç¤ºå•ä¸ªé¢‘é“çš„æ¢å¤æŒ‰é’®
                // å¯¹äºåŒ…å«éšè—é¢‘é“çš„åˆ†ç»„ï¼Œæ ¹æ®æ‰¹é‡æ¨¡å¼æ˜¾ç¤ºä¸åŒå†…å®¹
                container.innerHTML = `
                    <div class="my-playlist-channels">
                        ${group.channels.map(channel => `
                            <div class="my-playlist-channel deleted ${isBatchMode ? 'batch-mode' : ''}" data-channel-id="${channel.id}">
                                ${isBatchMode && group.isPartialDelete ? `
                                    <input type="checkbox" class="my-playlist-channel-checkbox" 
                                           onchange="toggleChannelSelection('${channel.id}')" 
                                           ${selectedChannels.has(channel.id) ? 'checked' : ''}>
                                ` : ''}
                                <div class="my-playlist-channel-name" title="${channel.name}" onclick="showChannelDetail('${channel.id}', true)" style="cursor: pointer;">${channel.name}</div>
                                ${group.isPartialDelete && !isBatchMode ? `
                                    <div class="my-playlist-channel-actions" style="opacity: 1 !important;">
                                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); restoreChannel('${channel.id}')">æ¢å¤</button>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // æ˜¾ç¤ºæ´»è·ƒåˆ†ç»„
                if (myPlaylistData.length === 0 || selectedGroupIndex >= myPlaylistData.length) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">è¯·é€‰æ‹©å·¦ä¾§åˆ†ç»„</div>';
                    header.style.display = 'none';
                    return;
                }

                group = myPlaylistData[selectedGroupIndex];
                
                // å¦‚æœå½“å‰é€‰ä¸­çš„åˆ†ç»„ä¸ºç©ºï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªéç©ºåˆ†ç»„
                if (group.channels.length === 0) {
                    const firstNonEmptyIndex = myPlaylistData.findIndex(g => g.channels.length > 0);
                    if (firstNonEmptyIndex === -1) {
                        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æ— å¯æ˜¾ç¤ºçš„é¢‘é“</div>';
                        header.style.display = 'none';
                        return;
                    }
                    selectedGroupIndex = firstNonEmptyIndex;
                    group = myPlaylistData[selectedGroupIndex];
                    // é‡æ–°æ¸²æŸ“åˆ†ç»„åˆ—è¡¨ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
                    renderGroupLists();
                }
                
                groupIndex = selectedGroupIndex;
                header.style.display = 'flex';
                title.textContent = `${group.name} (${group.channels.length}ä¸ªé¢‘é“)`;
                
                // æ ¹æ®æ‰¹é‡æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„æ“ä½œæŒ‰é’®
                if (isBatchMode) {
                    const selectedCount = selectedChannels.size;
                    actions.innerHTML = `
                        <button class="btn btn-sm" onclick="selectAllChannels()">å…¨é€‰</button>
                        <button class="btn btn-sm" onclick="deselectAllChannels()">å–æ¶ˆå…¨é€‰</button>
                        <button class="btn btn-warning btn-sm" onclick="hideSelectedChannels()" ${selectedCount === 0 ? 'disabled' : ''}>éšè—é€‰ä¸­ (${selectedCount})</button>
                        <button class="btn btn-danger btn-sm" onclick="keepSelectedChannels()" ${selectedCount === 0 ? 'disabled' : ''}>åªä¿ç•™é€‰ä¸­ (${selectedCount})</button>
                        <button class="btn btn-primary btn-sm" onclick="toggleBatchMode()">é€€å‡ºæ‰¹é‡</button>
                    `;
                } else {
                    actions.innerHTML = `
                        <button class="btn btn-sm" onclick="toggleBatchMode()">æ‰¹é‡ç®¡ç†</button>
                        <button class="btn btn-sm" onclick="moveGroupUp(${groupIndex})" ${groupIndex === 0 ? 'disabled' : ''}>â†‘ ä¸Šç§»</button>
                        <button class="btn btn-sm" onclick="moveGroupDown(${groupIndex})" ${groupIndex === myPlaylistData.length - 1 ? 'disabled' : ''}>â†“ ä¸‹ç§»</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteGroup(${groupIndex})">éšè—åˆ†ç»„</button>
                    `;
                }

                container.innerHTML = `
                    <div class="my-playlist-channels">
                        ${group.channels.map(channel => `
                            <div class="my-playlist-channel ${isBatchMode ? 'batch-mode' : ''}" data-channel-id="${channel.id}">
                                ${isBatchMode ? `
                                    <input type="checkbox" class="my-playlist-channel-checkbox" 
                                           onchange="toggleChannelSelection('${channel.id}')" 
                                           ${selectedChannels.has(channel.id) ? 'checked' : ''}>
                                ` : ''}
                                <div class="my-playlist-channel-name" title="${channel.name}" onclick="showChannelDetail('${channel.id}', false)" style="cursor: pointer;">${channel.name}</div>
                                ${!isBatchMode ? `
                                    <div class="my-playlist-channel-actions">
                                        <button onclick="event.stopPropagation(); hideChannel('${channel.id}')">éšè—</button>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        async function moveGroupUp(index) {
            if (index === 0) return;
            [myPlaylistData[index], myPlaylistData[index - 1]] = [myPlaylistData[index - 1], myPlaylistData[index]];
            updateGroupOrder();
            
            // è‡ªåŠ¨ä¿å­˜é…ç½®
            try {
                const response = await fetch('/api/my-playlist-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(myPlaylistConfig)
                });
                const result = await response.json();
                if (result.success) {
                    renderMyPlaylist();
                    showStatus('å·²ä¸Šç§»åˆ†ç»„', 'success');
                } else {
                    showStatus('ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function moveGroupDown(index) {
            if (index === myPlaylistData.length - 1) return;
            [myPlaylistData[index], myPlaylistData[index + 1]] = [myPlaylistData[index + 1], myPlaylistData[index]];
            updateGroupOrder();
            
            // è‡ªåŠ¨ä¿å­˜é…ç½®
            try {
                const response = await fetch('/api/my-playlist-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(myPlaylistConfig)
                });
                const result = await response.json();
                if (result.success) {
                    renderMyPlaylist();
                    showStatus('å·²ä¸‹ç§»åˆ†ç»„', 'success');
                } else {
                    showStatus('ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        function updateGroupOrder() {
            myPlaylistConfig.groupOrder = myPlaylistData.map(g => g.name);
        }

        async function deleteGroup(index) {
            const group = myPlaylistData[index];
            const confirmed = await showConfirm(`ç¡®å®šéšè—åˆ†ç»„ "${group.name}" å—ï¼Ÿ\nè¯¥åˆ†ç»„çš„ ${group.channels.length} ä¸ªé¢‘é“å°†è¢«ç§»åˆ°"å·²éšè—"åŒºåŸŸ`);
            if (!confirmed) {
                return;
            }
            
            myPlaylistConfig.deletedGroups.push(group.name);
            myPlaylistData.splice(index, 1);
            
            // è°ƒæ•´é€‰ä¸­ç´¢å¼•
            if (selectedGroupIndex >= myPlaylistData.length) {
                selectedGroupIndex = Math.max(0, myPlaylistData.length - 1);
            }
            
            updateGroupOrder();
            
            // è‡ªåŠ¨ä¿å­˜é…ç½®å¹¶é‡æ–°åŠ è½½æ•°æ®
            try {
                const response = await fetch('/api/my-playlist-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(myPlaylistConfig)
                });
                const result = await response.json();
                if (result.success) {
                    await loadMyPlaylist(false);
                    showStatus(`å·²éšè—åˆ†ç»„ "${group.name}"`, 'success');
                } else {
                    showStatus('éšè—å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('éšè—å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function hideChannel(channelId) {
            if (!myPlaylistConfig.hiddenChannels.includes(channelId)) {
                myPlaylistConfig.hiddenChannels.push(channelId);
            }
            
            // è‡ªåŠ¨ä¿å­˜é…ç½®å¹¶é‡æ–°åŠ è½½æ•°æ®
            try {
                const response = await fetch('/api/my-playlist-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(myPlaylistConfig)
                });
                const result = await response.json();
                if (result.success) {
                    await loadMyPlaylist(false);
                    showStatus('é¢‘é“å·²éšè—', 'success');
                } else {
                    showStatus('éšè—å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('éšè—å¤±è´¥: ' + error.message, 'error');
            }
        }



        async function restoreGroup() {
            if (!isViewingDeleted) return;

            const deletedGroups = myPlaylistOriginalData.filter(g => 
                myPlaylistConfig.deletedGroups.includes(g.name)
            );
            
            if (selectedGroupIndex >= deletedGroups.length) return;

            const group = deletedGroups[selectedGroupIndex];
            
            // ä»deletedGroupsä¸­ç§»é™¤
            myPlaylistConfig.deletedGroups = myPlaylistConfig.deletedGroups.filter(
                name => name !== group.name
            );

            // å…ˆä¿å­˜é…ç½®åˆ°æœåŠ¡å™¨
            try {
                const response = await fetch('/api/my-playlist-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(myPlaylistConfig)
                });
                const result = await response.json();
                if (result.success) {
                    // é‡æ–°åŠ è½½æ•°æ®ä½†ä¿æŒå½“å‰è§†å›¾
                    await loadMyPlaylist(false);
                    showStatus(`å·²æ¢å¤åˆ†ç»„ "${group.name}"`, 'success');
                } else {
                    showStatus('æ¢å¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ¢å¤åˆ†ç»„å¤±è´¥:', error);
                showStatus('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function restoreChannel(channelId) {
            console.log('æ¢å¤é¢‘é“:', channelId);
            console.log('å½“å‰ hiddenChannels:', myPlaylistConfig.hiddenChannels);
            
            // ä»hiddenChannelsä¸­ç§»é™¤
            myPlaylistConfig.hiddenChannels = myPlaylistConfig.hiddenChannels.filter(
                id => id !== channelId
            );
            
            console.log('æ›´æ–°å hiddenChannels:', myPlaylistConfig.hiddenChannels);

            // å…ˆä¿å­˜é…ç½®åˆ°æœåŠ¡å™¨
            try {
                const response = await fetch('/api/my-playlist-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(myPlaylistConfig)
                });
                const result = await response.json();
                console.log('ä¿å­˜é…ç½®ç»“æœ:', result);
                
                if (result.success) {
                    // é‡æ–°åŠ è½½æ•°æ®ä½†ä¿æŒå½“å‰è§†å›¾
                    await loadMyPlaylist(false);
                    console.log('æ•°æ®é‡æ–°åŠ è½½å®Œæˆ');
                    showStatus('é¢‘é“å·²æ¢å¤', 'success');
                } else {
                    showStatus('æ¢å¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ¢å¤é¢‘é“å¤±è´¥:', error);
                showStatus('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function restoreAllChannelsInGroup() {
            if (!isViewingDeleted) return;

            const deletedGroups = myPlaylistOriginalData.filter(g => 
                myPlaylistConfig.deletedGroups.includes(g.name)
            );
            const groupsWithHiddenChannels = myPlaylistOriginalData.map(g => {
                const hiddenChannels = g.channels.filter(ch => 
                    myPlaylistConfig.hiddenChannels.includes(ch.id) &&
                    !myPlaylistConfig.deletedGroups.includes(g.name)
                );
                return hiddenChannels.length > 0 ? {
                    ...g,
                    channels: hiddenChannels,
                    isPartialDelete: true
                } : null;
            }).filter(g => g !== null);

            const allDeletedGroups = [...deletedGroups, ...groupsWithHiddenChannels];
            
            if (selectedGroupIndex >= allDeletedGroups.length) return;

            const group = allDeletedGroups[selectedGroupIndex];

            // æ¢å¤è¿™ä¸ªåˆ†ç»„ä¸‹çš„æ‰€æœ‰é¢‘é“
            const channelIds = group.channels.map(ch => ch.id);
            myPlaylistConfig.hiddenChannels = myPlaylistConfig.hiddenChannels.filter(
                id => !channelIds.includes(id)
            );

            // å…ˆä¿å­˜é…ç½®åˆ°æœåŠ¡å™¨
            try {
                const response = await fetch('/api/my-playlist-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(myPlaylistConfig)
                });
                const result = await response.json();
                if (result.success) {
                    // é‡æ–°åŠ è½½æ•°æ®ä½†ä¿æŒå½“å‰è§†å›¾
                    await loadMyPlaylist(false);
                    showStatus(`å·²æ¢å¤ ${channelIds.length} ä¸ªé¢‘é“`, 'success');
                } else {
                    showStatus('æ¢å¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ¢å¤é¢‘é“å¤±è´¥:', error);
                showStatus('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            }
        }



        async function saveMyPlaylist() {
            try {
                const response = await fetch('/api/my-playlist-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(myPlaylistConfig)
                });

                const result = await response.json();
                if (result.success) {
                    showStatus('é…ç½®å·²ä¿å­˜', 'success');
                } else {
                    showStatus(result.message || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function resetMyPlaylist() {
            const confirmed = await showConfirm('ç¡®å®šé‡ç½®é…ç½®å—ï¼Ÿ\nå°†æ¢å¤åˆ°é»˜è®¤çŠ¶æ€');
            if (!confirmed) {
                return;
            }

            myPlaylistConfig = {
                channelGroupMap: {},
                hiddenChannels: [],
                customGroups: [],
                groupOrder: [],
                deletedGroups: []
            };

            await saveMyPlaylist();
            await loadMyPlaylist();
            showStatus('é…ç½®å·²é‡ç½®', 'success');
        }

        // æ‰¹é‡ç®¡ç†ç›¸å…³å‡½æ•°
        function toggleBatchMode() {
            isBatchMode = !isBatchMode;
            selectedChannels.clear();
            renderMyPlaylist();
        }

        function toggleChannelSelection(channelId) {
            if (selectedChannels.has(channelId)) {
                selectedChannels.delete(channelId);
            } else {
                selectedChannels.add(channelId);
            }
            renderGroupDetail(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æŒ‰é’®çŠ¶æ€
        }

        function selectAllChannels() {
            if (isViewingDeleted) {
                // "å·²éšè—"åŒºåŸŸ
                const deletedGroups = myPlaylistOriginalData.filter(g => 
                    myPlaylistConfig.deletedGroups.includes(g.name)
                );
                const groupsWithHiddenChannels = myPlaylistOriginalData.map(g => {
                    const hiddenChannels = g.channels.filter(ch => 
                        myPlaylistConfig.hiddenChannels.includes(ch.id) &&
                        !myPlaylistConfig.deletedGroups.includes(g.name)
                    );
                    return hiddenChannels.length > 0 ? {
                        ...g,
                        channels: hiddenChannels,
                        isPartialDelete: true
                    } : null;
                }).filter(g => g !== null);

                const allDeletedGroups = [...deletedGroups, ...groupsWithHiddenChannels];
                if (selectedGroupIndex >= allDeletedGroups.length) return;
                
                const group = allDeletedGroups[selectedGroupIndex];
                group.channels.forEach(channel => {
                    selectedChannels.add(channel.id);
                });
            } else {
                // "æˆ‘çš„é¢‘é“"åŒºåŸŸ
                if (myPlaylistData.length === 0 || selectedGroupIndex >= myPlaylistData.length) return;
                
                const group = myPlaylistData[selectedGroupIndex];
                group.channels.forEach(channel => {
                    selectedChannels.add(channel.id);
                });
            }
            renderGroupDetail();
        }

        function deselectAllChannels() {
            selectedChannels.clear();
            renderGroupDetail();
        }

        async function hideSelectedChannels() {
            if (selectedChannels.size === 0) return;

            const confirmed = await showConfirm(`ç¡®å®šéšè—é€‰ä¸­çš„ ${selectedChannels.size} ä¸ªé¢‘é“å—ï¼Ÿ`);
            if (!confirmed) return;

            // å°†é€‰ä¸­çš„é¢‘é“æ·»åŠ åˆ°hiddenChannels
            selectedChannels.forEach(channelId => {
                if (!myPlaylistConfig.hiddenChannels.includes(channelId)) {
                    myPlaylistConfig.hiddenChannels.push(channelId);
                }
            });

            try {
                const response = await fetch('/api/my-playlist-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(myPlaylistConfig)
                });
                const result = await response.json();
                if (result.success) {
                    selectedChannels.clear();
                    isBatchMode = false;
                    await loadMyPlaylist(false);
                    showStatus(`å·²éšè—é¢‘é“`, 'success');
                } else {
                    showStatus('éšè—å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('éšè—é¢‘é“å¤±è´¥:', error);
                showStatus('éšè—å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function keepSelectedChannels() {
            if (selectedChannels.size === 0) return;
            if (isViewingDeleted || myPlaylistData.length === 0 || selectedGroupIndex >= myPlaylistData.length) return;

            const group = myPlaylistData[selectedGroupIndex];
            const toHideCount = group.channels.length - selectedChannels.size;
            
            const confirmed = await showConfirm(
                `ç¡®å®šåªä¿ç•™é€‰ä¸­çš„ ${selectedChannels.size} ä¸ªé¢‘é“å—ï¼Ÿ\n` +
                `å°†éšè—å…¶ä»– ${toHideCount} ä¸ªé¢‘é“`
            );
            if (!confirmed) return;

            // éšè—æœªé€‰ä¸­çš„é¢‘é“
            group.channels.forEach(channel => {
                if (!selectedChannels.has(channel.id)) {
                    if (!myPlaylistConfig.hiddenChannels.includes(channel.id)) {
                        myPlaylistConfig.hiddenChannels.push(channel.id);
                    }
                }
            });

            try {
                const response = await fetch('/api/my-playlist-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(myPlaylistConfig)
                });
                const result = await response.json();
                if (result.success) {
                    selectedChannels.clear();
                    isBatchMode = false;
                    await loadMyPlaylist(false);
                    showStatus(`å·²ä¿ç•™é€‰ä¸­çš„é¢‘é“`, 'success');
                } else {
                    showStatus('æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                showStatus('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function restoreSelectedChannels() {
            if (selectedChannels.size === 0) return;
            if (!isViewingDeleted) return;

            const confirmed = await showConfirm(`ç¡®å®šæ¢å¤é€‰ä¸­çš„ ${selectedChannels.size} ä¸ªé¢‘é“å—ï¼Ÿ`);
            if (!confirmed) return;

            // ä»hiddenChannelsä¸­ç§»é™¤é€‰ä¸­çš„é¢‘é“
            selectedChannels.forEach(channelId => {
                const index = myPlaylistConfig.hiddenChannels.indexOf(channelId);
                if (index !== -1) {
                    myPlaylistConfig.hiddenChannels.splice(index, 1);
                }
            });

            try {
                const response = await fetch('/api/my-playlist-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(myPlaylistConfig)
                });
                const result = await response.json();
                if (result.success) {
                    selectedChannels.clear();
                    isBatchMode = false;
                    await loadMyPlaylist(false);
                    showStatus(`å·²æ¢å¤é¢‘é“`, 'success');
                } else {
                    showStatus('æ¢å¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ¢å¤é¢‘é“å¤±è´¥:', error);
                showStatus('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¢‘é“è¯¦æƒ…ç›¸å…³åŠŸèƒ½
        let currentChannelDetail = null;

        function showChannelDetail(channelId, isDeleted) {
            // ä»åŸå§‹æ•°æ®ä¸­æŸ¥æ‰¾é¢‘é“
            let channel = null;
            let groupName = null;
            let isExternal = false;

            // åœ¨åŸå§‹æ•°æ®ä¸­æŸ¥æ‰¾
            for (const group of myPlaylistOriginalData) {
                const found = group.channels.find(ch => ch.id === channelId);
                if (found) {
                    channel = found;
                    groupName = group.name;
                    // åˆ¤æ–­æ˜¯å¦ä¸ºå¤–éƒ¨æºé¢‘é“ï¼ˆåˆ†ç»„ä¸º"æœªåˆ†ç»„"ï¼‰
                    isExternal = group.name === 'æœªåˆ†ç»„';
                    break;
                }
            }

            if (!channel) {
                showStatus('é¢‘é“æœªæ‰¾åˆ°', 'error');
                return;
            }

            currentChannelDetail = { ...channel, groupName, isExternal, isDeleted };

            // æ„å»ºè¯¦æƒ…HTML
            let detailHTML = `
                <div style="line-height: 1.8;">
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #667eea;">é¢‘é“åç§°ï¼š</strong>
                        <span>${channel.name || 'æœªçŸ¥'}</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #667eea;">æ‰€å±åˆ†ç»„ï¼š</strong>
                        <span>${groupName || 'æœªçŸ¥'}</span>
                        ${isDeleted ? '<span style="color: #999; margin-left: 10px;">(å·²éšè—)</span>' : ''}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #667eea;">é¢‘é“IDï¼š</strong>
                        <span style="font-family: monospace; background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">${channel.id || 'æœªçŸ¥'}</span>
                    </div>
            `;

            // æ˜¾ç¤ºURL
            if (channel.url) {
                // è·å–å½“å‰é¡µé¢çš„base URLï¼ˆå»æ‰/adminåçš„éƒ¨åˆ†ï¼‰
                const baseUrl = window.location.origin + window.location.pathname.replace(/\/admin$/, '');
                // æ›¿æ¢URLä¸­çš„${replace}å ä½ç¬¦ä¸ºå®é™…çš„base URL
                const actualUrl = channel.url.replace(/\$\{replace\}/g, baseUrl);
                // æ„å»ºæ’­æ”¾å™¨URL
                const playerUrl = baseUrl + '/player?url=' + encodeURIComponent(actualUrl) + '&name=' + encodeURIComponent(channel.name || 'æœªçŸ¥é¢‘é“');
                
                detailHTML += `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #667eea;">æ’­æ”¾åœ°å€ï¼š</strong>
                        <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-top: 5px; word-break: break-all; font-family: monospace; font-size: 12px;">
                            ${actualUrl}
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-sm" onclick="copyToClipboard('${actualUrl.replace(/'/g, "\\'")}', 'æ’­æ”¾åœ°å€')">ğŸ“‹ å¤åˆ¶åœ°å€</button>
                            <button class="btn btn-sm btn-primary" onclick="openInPlayer('${actualUrl.replace(/'/g, "\\'")}')">ğŸ¬ æ‹‰èµ·æ’­æ”¾å™¨</button>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #999;">
                            ğŸ’¡ æç¤ºï¼šç‚¹å‡»"æ‹‰èµ·æ’­æ”¾å™¨"ä¼šè‡ªåŠ¨æ‰“å¼€æœ¬åœ°æ’­æ”¾å™¨ï¼ˆmacOS:IINA / Windows:PotPlayer / Linux:VLCï¼‰
                        </div>
                    </div>
                `;
            }

            // æ˜¾ç¤ºå…¶ä»–å¯ç”¨ä¿¡æ¯
            if (channel.tvgId) {
                detailHTML += `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #667eea;">TVG IDï¼š</strong>
                        <span>${channel.tvgId}</span>
                    </div>
                `;
            }

            if (channel.tvgName) {
                detailHTML += `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #667eea;">TVGåç§°ï¼š</strong>
                        <span>${channel.tvgName}</span>
                    </div>
                `;
            }

            if (channel.tvgLogo) {
                detailHTML += `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #667eea;">é¢‘é“å›¾æ ‡ï¼š</strong>
                        <div style="margin-top: 8px;">
                            <img src="${channel.tvgLogo}" alt="é¢‘é“å›¾æ ‡" style="max-width: 150px; max-height: 150px; border-radius: 4px;" onerror="this.style.display='none'">
                        </div>
                    </div>
                `;
            }

            // æ˜¾ç¤ºæ¥æºä¿¡æ¯
            if (isExternal) {
                detailHTML += `
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                        <span style="color: #999; font-size: 13px;">
                            â„¹ï¸ æ­¤é¢‘é“æ¥è‡ªå¤–éƒ¨æº
                        </span>
                    </div>
                `;
            } else {
                detailHTML += `
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                        <span style="color: #999; font-size: 13px;">
                            â„¹ï¸ æ­¤é¢‘é“æ¥è‡ªå’ªå’•æº
                        </span>
                    </div>
                `;
            }

            detailHTML += '</div>';

            // æ›´æ–°å¼¹çª—å†…å®¹
            document.getElementById('channelDetailTitle').textContent = `é¢‘é“è¯¦æƒ… - ${channel.name}`;
            document.getElementById('channelDetailContent').innerHTML = detailHTML;
            
            // æ˜¾ç¤º/éšè—ç¼–è¾‘æŒ‰é’®
            const editBtn = document.getElementById('channelDetailEditBtn');
            if (isExternal) {
                editBtn.style.display = 'block';
            } else {
                editBtn.style.display = 'none';
            }

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('channelDetailModal').style.display = 'block';
        }

        function closeChannelDetail() {
            document.getElementById('channelDetailModal').style.display = 'none';
            currentChannelDetail = null;
        }

        function copyToClipboard(text, label) {
            // ä¼˜å…ˆä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showStatus(`${label}å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success');
                }).catch(err => {
                    showStatus('å¤åˆ¶å¤±è´¥', 'error');
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                });
            } else {
                // å…¼å®¹ä¸æ”¯æŒ Clipboard API çš„ç¯å¢ƒï¼ˆHTTP æˆ–è€æ—§æµè§ˆå™¨ï¼‰
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try {
                    const success = document.execCommand('copy');
                    if (success) {
                        showStatus(`${label}å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success');
                    } else {
                        showStatus('å¤åˆ¶å¤±è´¥', 'error');
                    }
                } catch (err) {
                    showStatus('å¤åˆ¶å¤±è´¥', 'error');
                    console.error('å…¼å®¹å¤åˆ¶å¤±è´¥:', err);
                }
                document.body.removeChild(textarea);
            }
        }

        // æ£€æµ‹æ“ä½œç³»ç»Ÿå¹¶æ‹‰èµ·å¯¹åº”çš„æ’­æ”¾å™¨
        function openInPlayer(url) {
            const userAgent = navigator.userAgent.toLowerCase();
            const platform = navigator.platform.toLowerCase();
            
            let playerUrl = '';
            let playerName = '';
            let downloadUrl = '';
            
            // æ£€æµ‹æ“ä½œç³»ç»Ÿ
            if (platform.includes('mac') || userAgent.includes('mac')) {
                // macOS - ä½¿ç”¨ IINA
                playerUrl = 'iina://weblink?url=' + encodeURIComponent(url);
                playerName = 'IINA';
                downloadUrl = 'https://iina.io/';
            } else if (platform.includes('win') || userAgent.includes('windows')) {
                // Windows - ä½¿ç”¨ PotPlayer
                playerUrl = 'potplayer://' + url;
                playerName = 'PotPlayer';
                downloadUrl = 'https://potplayer.daum.net/';
            } else {
                // Linux æˆ–å…¶ä»–ç³»ç»Ÿ - ä½¿ç”¨ VLC
                playerUrl = 'vlc://' + url;
                playerName = 'VLC';
                downloadUrl = 'https://www.videolan.org/';
            }
            
            // ä¿å­˜å½“å‰æ’­æ”¾å™¨ä¿¡æ¯åˆ°å…¨å±€å˜é‡ä¾›ä¸‹è½½ä½¿ç”¨
            window.currentPlayerInfo = { name: playerName, downloadUrl: downloadUrl };
            
            // æ ‡è®°ï¼šæ’­æ”¾å™¨æ˜¯å¦æˆåŠŸå¯åŠ¨
            let playerLaunched = false;
            
            // ç›‘å¬çª—å£å¤±å»ç„¦ç‚¹äº‹ä»¶ï¼ˆæ’­æ”¾å™¨å¯åŠ¨æ—¶é€šå¸¸ä¼šå¯¼è‡´çª—å£å¤±ç„¦ï¼‰
            const onBlur = () => {
                playerLaunched = true;
                window.removeEventListener('blur', onBlur);
            };
            window.addEventListener('blur', onBlur);
            
            // å°è¯•æ‰“å¼€æ’­æ”¾å™¨
            const link = document.createElement('a');
            link.href = playerUrl;
            link.click();
            
            // å»¶è¿Ÿæ£€æµ‹ï¼šå¦‚æœæ’­æ”¾å™¨æœªå¯åŠ¨ï¼Œæ˜¾ç¤ºä¸‹è½½å¯¹è¯æ¡†
            setTimeout(() => {
                window.removeEventListener('blur', onBlur);
                if (!playerLaunched) {
                    showPlayerDownloadModal(playerName);
                }
            }, 2000);
        }

        // æ˜¾ç¤ºæ’­æ”¾å™¨ä¸‹è½½å¯¹è¯æ¡†
        function showPlayerDownloadModal(playerName) {
            document.getElementById('recommendedPlayer').textContent = playerName;
            document.getElementById('playerDownloadModal').style.display = 'flex';
        }

        // å…³é—­æ’­æ”¾å™¨ä¸‹è½½å¯¹è¯æ¡†
        function closePlayerDownloadModal() {
            document.getElementById('playerDownloadModal').style.display = 'none';
        }

        // è·³è½¬åˆ°æ’­æ”¾å™¨ä¸‹è½½é¡µé¢
        function goToPlayerDownload() {
            if (window.currentPlayerInfo && window.currentPlayerInfo.downloadUrl) {
                window.open(window.currentPlayerInfo.downloadUrl, '_blank');
                closePlayerDownloadModal();
            }
        }

        function editChannelFromDetail() {
            if (!currentChannelDetail || !currentChannelDetail.isExternal) {
                showStatus('æ­¤é¢‘é“ä¸å¯ç¼–è¾‘', 'error');
                return;
            }

            const channelName = currentChannelDetail.name;

            // å…³é—­è¯¦æƒ…å¼¹çª—
            closeChannelDetail();

            // åˆ‡æ¢åˆ°æºç®¡ç†tab
            switchTab(1);

            // å»¶è¿Ÿç¡®ä¿tabåˆ‡æ¢å’Œæ•°æ®åŠ è½½å®Œæˆï¼Œç„¶åæŸ¥æ‰¾å¹¶é€‰ä¸­å¯¹åº”çš„æº
            setTimeout(() => {
                // åœ¨å¤–éƒ¨æºåˆ—è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„æº
                if (!externalConfig.sources || externalConfig.sources.length === 0) {
                    showStatus('æœªæ‰¾åˆ°å¯¹åº”çš„å¤–éƒ¨æº', 'error');
                    return;
                }

                let foundIndex = -1;
                for (let i = 0; i < externalConfig.sources.length; i++) {
                    if (externalConfig.sources[i].name === channelName) {
                        foundIndex = i;
                        break;
                    }
                }

                if (foundIndex !== -1) {
                    // é€‰ä¸­è¯¥æº
                    selectExternalSource(foundIndex);
                    
                    // æ»šåŠ¨åˆ°è¯¥æºåœ¨å·¦ä¾§åˆ—è¡¨çš„ä½ç½®
                    const navItems = document.querySelectorAll('.external-nav-item');
                    if (navItems[foundIndex]) {
                        navItems[foundIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    
                    showStatus(`å·²å®šä½åˆ°æº: ${channelName}`, 'success');
                } else {
                    showStatus(`æœªæ‰¾åˆ°åä¸º"${channelName}"çš„å¤–éƒ¨æº`, 'error');
                }
            }, 300);
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(event) {
            const detailModal = document.getElementById('channelDetailModal');
            const downloadModal = document.getElementById('playerDownloadModal');
            
            if (event.target === detailModal) {
                closeChannelDetail();
            }
            
            if (event.target === downloadModal) {
                closePlayerDownloadModal();
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = loadData;
    </script>
</body>
</html>
