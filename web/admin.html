<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV é¢‘é“ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }

        .header .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #1890ff;
            color: white;
        }

        .btn-primary:hover {
            background: #40a9ff;
        }

        .btn-success {
            background: #52c41a;
            color: white;
        }

        .btn-success:hover {
            background: #73d13d;
        }

        .btn-danger {
            background: #ff4d4f;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 20px;
        }

        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 8px;
        }

        .search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .channel-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .category {
            margin-bottom: 20px;
        }

        .category-name {
            font-weight: bold;
            color: #1890ff;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 10px;
        }

        .channel-item {
            padding: 10px;
            margin: 5px 0;
            background: #fafafa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .channel-item:hover {
            background: #e6f7ff;
            transform: translateX(5px);
        }

        .channel-item.selected {
            background: #bae7ff;
            border-left: 3px solid #1890ff;
        }

        .custom-groups {
            max-height: 600px;
            overflow-y: auto;
        }

        .group {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-bottom: 15px;
            padding: 15px;
            background: #fafafa;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .group-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .group-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .group-channels {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .channel-tag {
            padding: 6px 12px;
            background: white;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .channel-tag .remove {
            color: #ff4d4f;
            cursor: pointer;
            font-weight: bold;
        }

        .channel-tag .remove:hover {
            color: #ff7875;
        }

        .empty-group {
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 400px;
        }

        .modal-content h3 {
            margin-bottom: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }

        .status.error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }

        .external-panel {
            margin-top: 20px;
        }

        .external-usage {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 4px;
            padding: 12px 16px;
            margin-bottom: 12px;
            font-size: 13px;
            line-height: 1.8;
        }

        .external-usage h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #1890ff;
        }

        .external-usage ol {
            margin: 0;
            padding-left: 20px;
            color: #595959;
        }

        .external-usage li {
            margin-bottom: 4px;
        }

        .external-toggles {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .external-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .external-list {
            max-height: 520px;
            overflow-y: auto;
        }

        .external-item {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 12px;
            background: #fafafa;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .external-item label {
            font-size: 12px;
            color: #666;
        }

        .external-item input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
        }

        .external-item .full {
            grid-column: 1 / -1;
        }

        .external-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        @media (max-width: 1280px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“º IPTV é¢‘é“ç®¡ç†</h1>
            <div class="status" id="status"></div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>ğŸ“‹ æ‰€æœ‰é¢‘é“</h2>
                <input type="text" class="search-box" id="searchBox" placeholder="æœç´¢é¢‘é“..." onkeyup="filterChannels()">
                <div class="channel-list" id="channelList"></div>
            </div>

            <div class="panel">
                <h2>â­ è‡ªå®šä¹‰åˆ†ç»„</h2>
                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="addGroup()">â• æ–°å»ºåˆ†ç»„</button>
                    <button class="btn btn-danger" onclick="resetAllGroups()">ğŸ”„ é‡ç½®æ‰€æœ‰åˆ†ç»„</button>
                    <button class="btn btn-success" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <label>
                        <input type="checkbox" id="enableCustom" onchange="toggleCustomGroups()">
                        å¯ç”¨è‡ªå®šä¹‰åˆ†ç»„
                    </label>
                </div>
                <div class="custom-groups" id="customGroups"></div>
            </div>

            <div class="panel">
                <h2>ğŸŒ å¤–éƒ¨æºç®¡ç†</h2>
                <div class="external-usage">
                    <h4>ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
                    <ol>
                        <li>å¡«å†™å¤–éƒ¨æºä¿¡æ¯ï¼š<strong>åç§°ã€åˆ†ç»„ã€å¾…æŠ“å–é“¾æ¥</strong></li>
                        <li>ç‚¹å‡» <strong>"æŠ“å–"</strong> æŒ‰é’®ï¼ŒæŠ“å–å®Œæˆåé¢‘é“é“¾æ¥ä¼šè‡ªåŠ¨å¡«å……åˆ° "m3u8 é“¾æ¥" è¾“å…¥æ¡†</li>
                        <li>ä¿®æ”¹é¢‘é“åã€åˆ†ç»„ç­‰ä¿¡æ¯åï¼Œè®°å¾—ç‚¹å‡» <strong>"ğŸ’¾ ä¿å­˜"</strong> æŒ‰é’®ä¿å­˜é…ç½®</li>
                    </ol>
                </div>
                <div class="external-toggles">
                    <label>
                        <input type="checkbox" id="externalEnabled" onchange="toggleExternalEnabled()">
                        å¯ç”¨å¤–éƒ¨æº
                    </label>
                    <label>
                        <input type="checkbox" id="externalIncludeInPlaylists" onchange="toggleExternalIncludeInPlaylists()">
                        å†™å…¥ m3u/txt
                    </label>
                </div>
                <div class="external-buttons">
                    <button class="btn btn-primary" onclick="addExternalSource()">â¥ æ·»åŠ å¤–éƒ¨æº</button>
                    <button class="btn btn-success" onclick="saveExternalSources()">ğŸ’¾ ä¿å­˜</button>
                </div>
                <div class="external-list" id="externalSourceList"></div>
            </div>
        </div>
    </div>

    <!-- æ–°å»º/ç¼–è¾‘åˆ†ç»„å¯¹è¯æ¡† -->
    <div class="modal" id="groupModal">
        <div class="modal-content">
            <h3 id="modalTitle">æ–°å»ºåˆ†ç»„</h3>
            <input type="text" id="groupNameInput" placeholder="è¾“å…¥åˆ†ç»„åç§°">
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="confirmGroup()">ç¡®å®š</button>
                <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        let allChannels = [];
        let config = {
            enableCustomGroups: false,
            customGroups: [],
            excludeChannels: []
        };
        let externalConfig = {
            enabled: false,
            includeInPlaylists: true,
            sources: []
        };
        let currentEditingGroup = null;
        let updatingSourceIndex = null; // è®°å½•æ­£åœ¨æ›´æ–°çš„æºç´¢å¼•

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // åŠ è½½æ‰€æœ‰é¢‘é“
                const channelsRes = await fetch('/api/channels');
                allChannels = await channelsRes.json();
                
                // åŠ è½½é…ç½®
                const configRes = await fetch('/api/config');
                config = await configRes.json();

                // åŠ è½½å¤–éƒ¨æºé…ç½®
                const externalRes = await fetch('/api/external-sources');
                const externalPayload = await externalRes.json();
                externalConfig = normalizeExternalConfig(externalPayload);
                
                renderChannels();
                renderGroups();
                renderExternalSources();
                document.getElementById('enableCustom').checked = config.enableCustomGroups;
            } catch (error) {
                showStatus('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“é¢‘é“åˆ—è¡¨
        function renderChannels() {
            const container = document.getElementById('channelList');
            container.innerHTML = '';
            
            allChannels.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.innerHTML = `<div class="category-name">${category.name}</div>`;
                
                category.dataList.forEach(channel => {
                    const channelDiv = document.createElement('div');
                    channelDiv.className = 'channel-item';
                    channelDiv.innerHTML = `
                        <span>${channel.name}</span>
                        <button class="btn btn-small btn-primary" onclick="addChannelToGroup('${channel.name}')">æ·»åŠ  âœ</button>
                    `;
                    categoryDiv.appendChild(channelDiv);
                });
                
                container.appendChild(categoryDiv);
            });
        }

        // æœç´¢é¢‘é“
        function filterChannels() {
            const keyword = document.getElementById('searchBox').value.toLowerCase();
            const items = document.querySelectorAll('.channel-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(keyword) ? 'flex' : 'none';
            });
        }

        // æ¸²æŸ“åˆ†ç»„
        function renderGroups() {
            const container = document.getElementById('customGroups');
            container.innerHTML = '';
            
            if (config.customGroups.length === 0) {
                container.innerHTML = '<div class="empty-group">æš‚æ— è‡ªå®šä¹‰åˆ†ç»„ï¼Œç‚¹å‡»ä¸Šæ–¹"â• æ·»åŠ æ–°åˆ†ç»„"æŒ‰é’®å¼€å§‹åˆ›å»º</div>';
                return;
            }
            
            config.customGroups.forEach((group, index) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group';
                
                const channelsHtml = group.channels.length > 0 
                    ? group.channels.map(ch => `
                        <div class="channel-tag">
                            ${ch}
                            <span class="remove" onclick="removeChannelFromGroup(${index}, '${ch}')">Ã—</span>
                        </div>
                    `).join('')
                    : '<div class="empty-group">æš‚æ— é¢‘é“ï¼Œä»å·¦ä¾§æ·»åŠ é¢‘é“</div>';
                
                groupDiv.innerHTML = `
                    <div class="group-header">
                        <div class="group-name">${group.name}</div>
                        <div class="group-actions">
                            <button class="btn btn-small btn-primary" onclick="editGroup(${index})">ç¼–è¾‘</button>
                            <button class="btn btn-small btn-danger" onclick="deleteGroup(${index})">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="group-channels">${channelsHtml}</div>
                `;
                
                container.appendChild(groupDiv);
            });
        }

        function normalizeExternalConfig(payload) {
            const data = payload && payload.data !== undefined ? payload.data : payload || {};
            if (Array.isArray(data)) {
                return {
                    enabled: true,
                    includeInPlaylists: true,
                    sources: data
                };
            }
            return {
                enabled: !!data.enabled,
                includeInPlaylists: data.includeInPlaylists !== false,
                sources: Array.isArray(data.sources) ? data.sources : []
            };
        }

        function renderExternalSources() {
            const container = document.getElementById('externalSourceList');
            container.innerHTML = '';

            document.getElementById('externalEnabled').checked = !!externalConfig.enabled;
            document.getElementById('externalIncludeInPlaylists').checked = externalConfig.includeInPlaylists !== false;

            if (!externalConfig.sources || externalConfig.sources.length === 0) {
                container.innerHTML = '<div class="empty-group">æš‚æ— å¤–éƒ¨æºï¼Œç‚¹å‡»â€œæ·»åŠ å¤–éƒ¨æºâ€å¼€å§‹é…ç½®</div>';
                return;
            }

            externalConfig.sources.forEach((source, index) => {
                const item = document.createElement('div');
                item.className = 'external-item';
                item.innerHTML = `
                    <div>
                        <label>åç§°</label>
                        <input type="text" value="${source.name || ''}" oninput="updateExternalField(${index}, 'name', this.value)">
                    </div>
                    <div>
                        <label>åˆ†ç»„</label>
                        <input type="text" value="${source.group || ''}" oninput="updateExternalField(${index}, 'group', this.value)">
                    </div>
                    <div class="full">
                        <label>ç½‘é¡µåœ°å€</label>
                        <input type="text" value="${source.webUrl || ''}" oninput="updateExternalField(${index}, 'webUrl', this.value)">
                    </div>
                    <div class="full">
                        <label>m3u8 é“¾æ¥</label>
                        <input type="text" value="${source.m3u8Url || ''}" oninput="updateExternalField(${index}, 'm3u8Url', this.value)">
                    </div>
                    <div class="external-actions full">
                        <label>
                            <input type="checkbox" ${source.enabled !== false ? 'checked' : ''} onchange="updateExternalField(${index}, 'enabled', this.checked)">
                            å¯ç”¨
                        </label>
                        <button class="btn btn-small btn-primary" onclick="updateExternalSource(${index})" ${updatingSourceIndex === index ? 'disabled' : ''}>
                            ${updatingSourceIndex === index ? 'æŠ“å–ä¸­...' : 'æŠ“å–'}
                        </button>
                        <button class="btn btn-small btn-danger" onclick="removeExternalSource(${index})" ${updatingSourceIndex === index ? 'disabled' : ''}>åˆ é™¤</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function toggleExternalEnabled() {
            externalConfig.enabled = document.getElementById('externalEnabled').checked;
        }

        function toggleExternalIncludeInPlaylists() {
            externalConfig.includeInPlaylists = document.getElementById('externalIncludeInPlaylists').checked;
        }

        function addExternalSource() {
            externalConfig.sources.push({
                name: '',
                group: 'å…¶ä»–',
                webUrl: '',
                m3u8Url: '',
                enabled: true,
                extractOptions: {
                    waitTime: 5000,
                    headless: true
                }
            });
            renderExternalSources();
        }

        function removeExternalSource(index) {
            externalConfig.sources.splice(index, 1);
            renderExternalSources();
        }

        function updateExternalField(index, field, value) {
            externalConfig.sources[index][field] = value;
        }

        async function updateExternalSource(index) {
            if (updatingSourceIndex !== null) {
                showStatus('è¯·ç­‰å¾…å½“å‰æŠ“å–å®Œæˆ', 'error');
                return;
            }
            
            const sourceName = externalConfig.sources[index].name || 'å¤–éƒ¨æº';
            updatingSourceIndex = index;
            renderExternalSources(); // åˆ·æ–°UIæ˜¾ç¤ºloadingçŠ¶æ€
            
            try {
                // å…ˆä¿å­˜é…ç½®ï¼Œç¡®ä¿åç«¯ç´¢å¼•åŒæ­¥
                showStatus(`æ­£åœ¨ä¿å­˜é…ç½®...`, 'info');
                const saveResponse = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'save', sources: externalConfig })
                });
                
                if (!saveResponse.ok) {
                    showStatus('é…ç½®ä¿å­˜å¤±è´¥ï¼Œæ— æ³•æ›´æ–°', 'error');
                    return;
                }
                
                // ä¿å­˜æˆåŠŸåæ‰§è¡Œæ›´æ–°
                showStatus(`æ­£åœ¨æå– ${sourceName} çš„ m3u8 é“¾æ¥...`, 'info');
                
                const response = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'update', index })
                });

                const result = await response.json();
                
                // é‡æ–°åŠ è½½é…ç½®ç¡®ä¿UIåŒæ­¥ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥éƒ½åŠ è½½ï¼‰
                const externalRes = await fetch('/api/external-sources');
                const externalPayload = await externalRes.json();
                externalConfig = normalizeExternalConfig(externalPayload);
                
                // æ ¹æ® result.success åˆ¤æ–­è€Œä¸æ˜¯ response.ok
                if (result.success !== false) {
                    const message = result.warning 
                        ? `${sourceName} æ›´æ–°æˆåŠŸï¼ˆ${result.warning}ï¼‰` 
                        : `${sourceName} æ›´æ–°æˆåŠŸï¼m3u8 é“¾æ¥å·²è‡ªåŠ¨å¡«å……`;
                    showStatus(message, 'success');
                } else {
                    showStatus(`${sourceName} æ›´æ–°å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showStatus(`${sourceName} æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            } finally {
                updatingSourceIndex = null;
                renderExternalSources(); // æ¸…é™¤loadingçŠ¶æ€å¹¶åˆ·æ–°UI
            }
        }

        async function saveExternalSources() {
            try {
                showStatus('æ­£åœ¨ä¿å­˜é…ç½®...', 'info');
                
                const response = await fetch('/api/external-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'save', sources: externalConfig })
                });

                const result = await response.json();
                if (response.ok && result.success !== false) {
                    showStatus('å¤–éƒ¨æºé…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    renderExternalSources(); // ä¿å­˜æˆåŠŸååˆ·æ–°UI
                } else {
                    showStatus(result.message || 'å¤–éƒ¨æºé…ç½®ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('å¤–éƒ¨æºé…ç½®ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ–°å»ºåˆ†ç»„
        function addGroup() {
            currentEditingGroup = null;
            document.getElementById('modalTitle').textContent = 'æ–°å»ºåˆ†ç»„';
            document.getElementById('groupNameInput').value = '';
            document.getElementById('groupModal').style.display = 'block';
        }

        // ç¼–è¾‘åˆ†ç»„
        function editGroup(index) {
            currentEditingGroup = index;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘åˆ†ç»„';
            document.getElementById('groupNameInput').value = config.customGroups[index].name;
            document.getElementById('groupModal').style.display = 'block';
        }

        // ç¡®è®¤åˆ†ç»„
        function confirmGroup() {
            const name = document.getElementById('groupNameInput').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                return;
            }
            
            if (currentEditingGroup === null) {
                // æ–°å»º
                config.customGroups.push({
                    name: name,
                    channels: []
                });
            } else {
                // ç¼–è¾‘
                config.customGroups[currentEditingGroup].name = name;
            }
            
            closeModal();
            renderGroups();
        }

        // åˆ é™¤åˆ†ç»„
        function deleteGroup(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç»„å—ï¼Ÿ')) {
                config.customGroups.splice(index, 1);
                renderGroups();
            }
        }

        // é‡ç½®æ‰€æœ‰åˆ†ç»„ï¼ˆå°†é»˜è®¤åˆ†ç»„ä½œä¸ºè‡ªå®šä¹‰åˆ†ç»„çš„åˆå§‹å€¼ï¼‰
        async function resetAllGroups() {
            if (confirm('ç¡®å®šè¦é‡ç½®åˆ†ç»„å—ï¼Ÿ\n\nè¿™å°†æŠŠå½“å‰çš„é»˜è®¤åˆ†ç»„å¯¼å…¥ä¸ºè‡ªå®šä¹‰åˆ†ç»„ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œè°ƒæ•´ã€‚')) {
                try {
                    const response = await fetch('/api/reset-groups', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // é‡æ–°åŠ è½½é…ç½®
                        config = result.data;
                        document.getElementById('enableCustom').checked = config.enableCustomGroups;
                        renderGroups();
                        showStatus(result.message, 'success');
                    } else {
                        showStatus(result.message || 'é‡ç½®å¤±è´¥', 'error');
                    }
                } catch (error) {
                    showStatus('é‡ç½®å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        // æ·»åŠ é¢‘é“åˆ°å½“å‰é€‰ä¸­åˆ†ç»„
        let currentSelectedGroup = 0;
        function addChannelToGroup(channelName) {
            if (config.customGroups.length === 0) {
                alert('è¯·å…ˆåˆ›å»ºåˆ†ç»„');
                return;
            }
            
            // ç®€å•å®ç°ï¼šæ·»åŠ åˆ°ç¬¬ä¸€ä¸ªåˆ†ç»„ï¼Œå¯ä»¥æ”¹è¿›ä¸ºå¼¹çª—é€‰æ‹©
            const groupIndex = currentSelectedGroup % config.customGroups.length;
            const group = config.customGroups[groupIndex];
            
            if (!group.channels.includes(channelName)) {
                group.channels.push(channelName);
                renderGroups();
                showStatus(`å·²æ·»åŠ  "${channelName}" åˆ° "${group.name}"`, 'success');
            } else {
                showStatus(`"${channelName}" å·²åœ¨åˆ†ç»„ä¸­`, 'error');
            }
        }

        // ä»åˆ†ç»„ç§»é™¤é¢‘é“
        function removeChannelFromGroup(groupIndex, channelName) {
            const group = config.customGroups[groupIndex];
            group.channels = group.channels.filter(ch => ch !== channelName);
            renderGroups();
        }

        // åˆ‡æ¢è‡ªå®šä¹‰åˆ†ç»„
        function toggleCustomGroups() {
            config.enableCustomGroups = document.getElementById('enableCustom').checked;
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    showStatus('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                } else {
                    showStatus('é…ç½®ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å…³é—­å¯¹è¯æ¡†
        function closeModal() {
            document.getElementById('groupModal').style.display = 'none';
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = loadData;
    </script>
</body>
</html>
